<!-- LamApp/supermarkets/templates/tasks/progress.html -->
{% extends 'base.html' %}
{% load static %}
{% block title %}Task in Progress{% endblock %}
{% block page_title %}Processing...{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="stat-card">
                <h4 class="mb-4">
                    <i class="bi bi-hourglass-split text-primary"></i>
                    Task in Progress
                </h4>

                {% if storage %}
                <div class="alert alert-info">
                    <strong>Storage:</strong> {{ storage.supermarket.name }} - {{ storage.name }}
                </div>
                {% endif %}

                <!-- Progress Section -->
                <div id="progressSection">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="statusText">Processing...</span>
                            <span class="text-muted" id="progressPercent">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progressBar" 
                                 class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%">
                                0%
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-secondary">
                        <p class="mb-2"><i class="bi bi-info-circle"></i> <strong>What's happening?</strong></p>
                        <ul class="mb-0 small">
                            <li>Your task is running in the background</li>
                            <li>This page will auto-update every 5 seconds</li>
                            <li>You can safely close this page and check back later</li>
                            <li>Typical operations take 5-15 minutes</li>
                        </ul>
                    </div>
                </div>

                <!-- Success Section (hidden by default) -->
                <div id="successSection" style="display: none;" class="alert alert-success">
                    <h6><i class="bi bi-check-circle"></i> Task Completed!</h6>
                    <p id="successMessage" class="mb-2"></p>
                    <div id="successActions" class="mt-3"></div>
                </div>

                <!-- Error Section (hidden by default) -->
                <div id="errorSection" style="display: none;" class="alert alert-danger">
                    <h6><i class="bi bi-x-circle"></i> Task Failed</h6>
                    <p id="errorMessage" class="mb-2"></p>
                    <button onclick="window.location.reload()" class="btn btn-warning btn-sm">
                        <i class="bi bi-arrow-repeat"></i> Retry
                    </button>
                </div>

                <!-- Action Buttons -->
                <div class="mt-4">
                    {% if storage %}
                    <a href="{% url 'storage-detail' pk=storage.id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Storage
                    </a>
                    {% else %}
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- ✅ LOAD SHARED POLLER -->
<script src="{% static 'js/task-poller.js' %}"></script>

<script>
// ✅ USE SHARED POLLER (replaces 100+ lines of duplicate code)
const poller = new TaskPoller('{{ task_id }}', {
    onProgress: (data) => {
        // Update progress bar
        const progress = data.progress || 0;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressBar').textContent = progress + '%';
        document.getElementById('progressPercent').textContent = progress + '%';
        document.getElementById('statusText').textContent = 
            data.status_message || 'Processing...';
    },
    
    onSuccess: (data) => {
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('successSection').style.display = 'block';
        
        const messageEl = document.getElementById('successMessage');
        const actionsEl = document.getElementById('successActions');
        
        messageEl.textContent = data.message || 'Task completed successfully!';
        
        if (data.redirect_url) {
            actionsEl.innerHTML = `
                <a href="${data.redirect_url}" class="btn btn-success">
                    <i class="bi bi-check"></i> View Results
                </a>
            `;
            // Auto-redirect after 2 seconds
            setTimeout(() => window.location.href = data.redirect_url, 2000);
        } else {
            actionsEl.innerHTML = `
                <a href="/dashboard/" class="btn btn-success">
                    <i class="bi bi-check"></i> Back to Dashboard
                </a>
            `;
        }
    },
    
    onError: (error) => {
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = error;
    },
    
    onTimeout: () => {
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = 
            'Task timed out. Please refresh to check status.';
    }
});

// Start polling when page loads
document.addEventListener('DOMContentLoaded', () => poller.start());
</script>
{% endblock %}