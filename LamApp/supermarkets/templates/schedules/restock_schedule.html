<!-- LamApp/supermarkets/templates/schedules/restock_schedule.html -->
{% extends "base.html" %}
{% block title %}Agenda ordini - {{ storage.name }}{% endblock %}
{% block page_title %}Agenda ordini{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'supermarket-detail' pk=storage.supermarket.id %}">{{ storage.supermarket.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'storage-detail' pk=storage.id %}">{{ storage.name }}</a></li>
                    <li class="breadcrumb-item active">Agenda ordini</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <div class="stat-card">
                <h4 class="mb-4">
                    <i class="bi bi-calendar-check text-primary"></i>
                    Configura Agenda ordini
                </h4>

                <!-- Visual Weekly Calendar Preview -->
                <div class="card mb-4 border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-eye"></i> Anteprima Settimanale
                        </h6>
                        <div class="d-flex justify-content-between gap-1" id="weeklyCalendar">
                            <div class="text-center flex-fill p-2 rounded" data-day="monday" style="min-width: 13%;">
                                <div class="fw-bold small">Lun</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="tuesday" style="min-width: 13%;">
                                <div class="fw-bold small">Mar</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="wednesday" style="min-width: 13%;">
                                <div class="fw-bold small">Mer</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="thursday" style="min-width: 13%;">
                                <div class="fw-bold small">Gio</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="friday" style="min-width: 13%;">
                                <div class="fw-bold small">Ven</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="saturday" style="min-width: 13%;">
                                <div class="fw-bold small">Sab</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="sunday" style="min-width: 13%;">
                                <div class="fw-bold small">Dom</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                        </div>
                        <div class="mt-3 d-flex gap-3 justify-content-center small">
                            <span><i class="bi bi-cart-fill text-primary"></i> Giorno ordine</span>
                            <span><i class="bi bi-truck text-success"></i> Giorno consegna</span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Come funziona</h6>
                    <ul class="mb-0">
                        <li><strong>Giorni di ordine:</strong> Attiva i giorni in cui vuoi effettuare gli ordini</li>
                        <li><strong>Tempi di consegna:</strong>
                            <ul class="mt-1 mb-1">
                                <li><i class="bi bi-lightning-fill text-warning"></i> <strong>Stesso giorno</strong> - La merce arriva il giorno stesso dell'ordine</li>
                                <li><i class="bi bi-calendar-plus text-primary"></i> <strong>Giorno seguente</strong> - La merce arriva il giorno dopo l'ordine</li>
                                <li><i class="bi bi-gear text-secondary"></i> <strong>Altro ritardo</strong> - Per consegne con più giorni di attesa (es. festività, weekend)</li>
                            </ul>
                        </li>
                        <li><strong>Copertura:</strong> Calcolata automaticamente - indica quanti giorni copre ogni ordine</li>
                        <li><strong>Orario:</strong> Gli ordini vengono eseguiti automaticamente alle 6:00</li>
                    </ul>
                </div>

                <form method="post" id="scheduleForm">
                    {% csrf_token %}

                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-calendar-plus text-primary"></i>
                            Seleziona i giorni di ordine
                        </h5>
                        <p class="text-muted small mb-3">Clicca su un giorno per abilitare/disabilitare l'ordine, poi scegli quando arriva la consegna:</p>

                        <!-- Day Cards Grid -->
                        <div class="row g-3">
                            <!-- Monday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="monday" id="card_monday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Lunedì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.monday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-2">Quando arriva la merce?</label>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="monday_offset_radio" id="monday_offset_0" value="0">
                                                    <label class="btn btn-outline-primary btn-sm" for="monday_offset_0">
                                                        <i class="bi bi-lightning-fill"></i> Stesso giorno
                                                    </label>
                                                    <input type="radio" class="btn-check" name="monday_offset_radio" id="monday_offset_1" value="1" checked>
                                                    <label class="btn btn-outline-primary btn-sm" for="monday_offset_1">
                                                        <i class="bi bi-calendar-plus"></i> Giorno seguente
                                                    </label>
                                                </div>
                                                <div class="custom-delay-section mt-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <input type="checkbox" class="form-check-input" id="monday_custom_toggle">
                                                        <label class="form-check-label small text-muted" for="monday_custom_toggle">
                                                            Altro ritardo
                                                        </label>
                                                        <input type="number" class="form-control form-control-sm custom-delay-input"
                                                               id="monday_custom_days" min="2" max="7" value="2"
                                                               style="width: 60px; display: none;">
                                                        <span class="small text-muted custom-delay-label" style="display: none;">giorni</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_monday">Martedì</span>
                                            </div>
                                            {{ form.monday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Tuesday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="tuesday" id="card_tuesday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Martedì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.tuesday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-2">Quando arriva la merce?</label>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="tuesday_offset_radio" id="tuesday_offset_0" value="0">
                                                    <label class="btn btn-outline-primary btn-sm" for="tuesday_offset_0">
                                                        <i class="bi bi-lightning-fill"></i> Stesso giorno
                                                    </label>
                                                    <input type="radio" class="btn-check" name="tuesday_offset_radio" id="tuesday_offset_1" value="1" checked>
                                                    <label class="btn btn-outline-primary btn-sm" for="tuesday_offset_1">
                                                        <i class="bi bi-calendar-plus"></i> Giorno seguente
                                                    </label>
                                                </div>
                                                <div class="custom-delay-section mt-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <input type="checkbox" class="form-check-input" id="tuesday_custom_toggle">
                                                        <label class="form-check-label small text-muted" for="tuesday_custom_toggle">
                                                            Altro ritardo
                                                        </label>
                                                        <input type="number" class="form-control form-control-sm custom-delay-input"
                                                               id="tuesday_custom_days" min="2" max="7" value="2"
                                                               style="width: 60px; display: none;">
                                                        <span class="small text-muted custom-delay-label" style="display: none;">giorni</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_tuesday">Mercoledì</span>
                                            </div>
                                            {{ form.tuesday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Wednesday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="wednesday" id="card_wednesday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Mercoledì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.wednesday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-2">Quando arriva la merce?</label>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="wednesday_offset_radio" id="wednesday_offset_0" value="0">
                                                    <label class="btn btn-outline-primary btn-sm" for="wednesday_offset_0">
                                                        <i class="bi bi-lightning-fill"></i> Stesso giorno
                                                    </label>
                                                    <input type="radio" class="btn-check" name="wednesday_offset_radio" id="wednesday_offset_1" value="1" checked>
                                                    <label class="btn btn-outline-primary btn-sm" for="wednesday_offset_1">
                                                        <i class="bi bi-calendar-plus"></i> Giorno seguente
                                                    </label>
                                                </div>
                                                <div class="custom-delay-section mt-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <input type="checkbox" class="form-check-input" id="wednesday_custom_toggle">
                                                        <label class="form-check-label small text-muted" for="wednesday_custom_toggle">
                                                            Altro ritardo
                                                        </label>
                                                        <input type="number" class="form-control form-control-sm custom-delay-input"
                                                               id="wednesday_custom_days" min="2" max="7" value="2"
                                                               style="width: 60px; display: none;">
                                                        <span class="small text-muted custom-delay-label" style="display: none;">giorni</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_wednesday">Giovedì</span>
                                            </div>
                                            {{ form.wednesday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Thursday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="thursday" id="card_thursday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Giovedì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.thursday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-2">Quando arriva la merce?</label>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="thursday_offset_radio" id="thursday_offset_0" value="0">
                                                    <label class="btn btn-outline-primary btn-sm" for="thursday_offset_0">
                                                        <i class="bi bi-lightning-fill"></i> Stesso giorno
                                                    </label>
                                                    <input type="radio" class="btn-check" name="thursday_offset_radio" id="thursday_offset_1" value="1" checked>
                                                    <label class="btn btn-outline-primary btn-sm" for="thursday_offset_1">
                                                        <i class="bi bi-calendar-plus"></i> Giorno seguente
                                                    </label>
                                                </div>
                                                <div class="custom-delay-section mt-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <input type="checkbox" class="form-check-input" id="thursday_custom_toggle">
                                                        <label class="form-check-label small text-muted" for="thursday_custom_toggle">
                                                            Altro ritardo
                                                        </label>
                                                        <input type="number" class="form-control form-control-sm custom-delay-input"
                                                               id="thursday_custom_days" min="2" max="7" value="2"
                                                               style="width: 60px; display: none;">
                                                        <span class="small text-muted custom-delay-label" style="display: none;">giorni</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_thursday">Venerdì</span>
                                            </div>
                                            {{ form.thursday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Friday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="friday" id="card_friday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Venerdì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.friday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-2">Quando arriva la merce?</label>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="friday_offset_radio" id="friday_offset_0" value="0">
                                                    <label class="btn btn-outline-primary btn-sm" for="friday_offset_0">
                                                        <i class="bi bi-lightning-fill"></i> Stesso giorno
                                                    </label>
                                                    <input type="radio" class="btn-check" name="friday_offset_radio" id="friday_offset_1" value="1" checked>
                                                    <label class="btn btn-outline-primary btn-sm" for="friday_offset_1">
                                                        <i class="bi bi-calendar-plus"></i> Giorno seguente
                                                    </label>
                                                </div>
                                                <div class="custom-delay-section mt-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <input type="checkbox" class="form-check-input" id="friday_custom_toggle">
                                                        <label class="form-check-label small text-muted" for="friday_custom_toggle">
                                                            Altro ritardo
                                                        </label>
                                                        <input type="number" class="form-control form-control-sm custom-delay-input"
                                                               id="friday_custom_days" min="2" max="7" value="2"
                                                               style="width: 60px; display: none;">
                                                        <span class="small text-muted custom-delay-label" style="display: none;">giorni</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_friday">Sabato</span>
                                            </div>
                                            {{ form.friday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Saturday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="saturday" id="card_saturday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Sabato
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.saturday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-2">Quando arriva la merce?</label>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="saturday_offset_radio" id="saturday_offset_0" value="0">
                                                    <label class="btn btn-outline-primary btn-sm" for="saturday_offset_0">
                                                        <i class="bi bi-lightning-fill"></i> Stesso giorno
                                                    </label>
                                                    <input type="radio" class="btn-check" name="saturday_offset_radio" id="saturday_offset_1" value="1" checked>
                                                    <label class="btn btn-outline-primary btn-sm" for="saturday_offset_1">
                                                        <i class="bi bi-calendar-plus"></i> Giorno seguente
                                                    </label>
                                                </div>
                                                <div class="custom-delay-section mt-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <input type="checkbox" class="form-check-input" id="saturday_custom_toggle">
                                                        <label class="form-check-label small text-muted" for="saturday_custom_toggle">
                                                            Altro ritardo
                                                        </label>
                                                        <input type="number" class="form-control form-control-sm custom-delay-input"
                                                               id="saturday_custom_days" min="2" max="7" value="2"
                                                               style="width: 60px; display: none;">
                                                        <span class="small text-muted custom-delay-label" style="display: none;">giorni</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_saturday">Domenica</span>
                                            </div>
                                            {{ form.saturday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Sunday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="sunday" id="card_sunday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Domenica
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.sunday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-2">Quando arriva la merce?</label>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="sunday_offset_radio" id="sunday_offset_0" value="0">
                                                    <label class="btn btn-outline-primary btn-sm" for="sunday_offset_0">
                                                        <i class="bi bi-lightning-fill"></i> Stesso giorno
                                                    </label>
                                                    <input type="radio" class="btn-check" name="sunday_offset_radio" id="sunday_offset_1" value="1" checked>
                                                    <label class="btn btn-outline-primary btn-sm" for="sunday_offset_1">
                                                        <i class="bi bi-calendar-plus"></i> Giorno seguente
                                                    </label>
                                                </div>
                                                <div class="custom-delay-section mt-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <input type="checkbox" class="form-check-input" id="sunday_custom_toggle">
                                                        <label class="form-check-label small text-muted" for="sunday_custom_toggle">
                                                            Altro ritardo
                                                        </label>
                                                        <input type="number" class="form-control form-control-sm custom-delay-input"
                                                               id="sunday_custom_days" min="2" max="7" value="2"
                                                               style="width: 60px; display: none;">
                                                        <span class="small text-muted custom-delay-label" style="display: none;">giorni</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_sunday">Lunedì</span>
                                            </div>
                                            {{ form.sunday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coverage Preview -->
                    <div id="coveragePreview" class="alert alert-secondary mb-4" style="display: none;">
                        <h6><i class="bi bi-calculator"></i> Anteprima della copertura</h6>
                        <div id="coverageDisplay"></div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{% url 'storage-detail' pk=storage.id %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Annulla
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Salva agenda ordini
                        </button>
                    </div>
                </form>

                <!-- 3-Month Calendar Planning Section -->
                <div class="mt-5 pt-4 border-top">
                    <h5 class="mb-3">
                        <i class="bi bi-calendar3 text-primary"></i>
                        Pianificazione 3 Mesi
                    </h5>
                    <p class="text-muted small mb-3">
                        Il calendario mostra automaticamente i giorni di ordine in base alla settimana tipo configurata sopra.
                        <strong>Clicca su un giorno</strong> per aggiungere eccezioni (festività, chiusure, modifiche).
                    </p>

                    <style>
                        .calendar-table td {
                            padding: 4px 2px;
                            vertical-align: top;
                            height: 36px;
                        }
                        .calendar-table th {
                            padding: 4px 2px;
                            font-weight: 500;
                        }
                        .cal-day-num {
                            font-size: 0.85rem;
                            line-height: 1;
                        }
                        .cal-dots {
                            display: flex;
                            justify-content: center;
                            gap: 2px;
                            margin-top: 2px;
                        }
                        .cal-dot {
                            display: inline-block;
                            width: 6px;
                            height: 6px;
                            border-radius: 50%;
                        }
                        .calendar-cell:hover:not(.text-muted) {
                            background-color: rgba(0,0,0,0.05);
                            border-radius: 4px;
                        }
                        .legend-dot {
                            display: inline-block;
                            width: 10px;
                            height: 10px;
                            border-radius: 50%;
                            vertical-align: middle;
                            margin-right: 4px;
                        }
                        /* Custom dialog (replaces Bootstrap Modal) */
                        .exception-overlay {
                            position: fixed;
                            top: 0; left: 0; right: 0; bottom: 0;
                            background: rgba(0,0,0,0.5);
                            z-index: 1050;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .exception-dialog {
                            background: #fff;
                            border-radius: 8px;
                            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
                            width: 100%;
                            max-width: 500px;
                            margin: 1rem;
                        }
                        .exception-dialog-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 1rem 1.25rem;
                            border-bottom: 1px solid #dee2e6;
                        }
                        .exception-dialog-body {
                            padding: 1.25rem;
                        }
                        .exception-dialog-footer {
                            display: flex;
                            justify-content: flex-end;
                            gap: 0.5rem;
                            padding: 0.75rem 1.25rem;
                            border-top: 1px solid #dee2e6;
                        }
                        .exception-dialog-footer #removeExceptionBtn {
                            margin-right: auto;
                        }
                    </style>
                    <div class="alert alert-light border mb-3">
                        <div class="d-flex flex-wrap gap-4 small align-items-center">
                            <span><span class="legend-dot bg-primary"></span> Ordine</span>
                            <span><span class="legend-dot bg-success"></span> Consegna</span>
                            <span><span class="legend-dot bg-danger"></span> Saltato</span>
                            <span><span class="legend-dot bg-warning"></span> Aggiunto</span>
                            <span class="text-muted ms-2"><i class="bi bi-hand-index"></i> Clicca su un giorno per modificare</span>
                        </div>
                    </div>

                    <!-- Calendar Navigation -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="calendarPrevMonth">
                            <i class="bi bi-chevron-left"></i> Mese precedente
                        </button>
                        <span class="fw-bold" id="calendarCurrentRange">Gennaio - Marzo 2026</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="calendarNextMonth">
                            Mese successivo <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <!-- 3-Month Calendar Grid -->
                    <div class="row g-3" id="threeMonthCalendar">
                        <!-- Calendars will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Exception Dialog (custom, no Bootstrap Modal) -->
                <div id="exceptionOverlay" class="exception-overlay" style="display:none;">
                    <div class="exception-dialog">
                        <div class="exception-dialog-header">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar-event"></i>
                                Gestisci giorno: <span id="exceptionModalDate"></span>
                            </h5>
                            <button type="button" class="btn-close" id="exceptionCloseBtn"></button>
                        </div>
                        <div class="exception-dialog-body">
                            <input type="hidden" id="exceptionDateInput">

                            <div class="mb-3">
                                <label class="form-label">Tipo di eccezione</label>
                                <div class="d-flex flex-column gap-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="exceptionType" id="exceptionTypeSkip" value="skip" checked>
                                        <label class="form-check-label" for="exceptionTypeSkip">
                                            <i class="bi bi-x-circle text-danger"></i>
                                            <strong>Salta ordine</strong>
                                            <small class="text-muted d-block">Non effettuare l'ordine in questo giorno</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="exceptionType" id="exceptionTypeAdd" value="add">
                                        <label class="form-check-label" for="exceptionTypeAdd">
                                            <i class="bi bi-plus-circle text-success"></i>
                                            <strong>Aggiungi ordine</strong>
                                            <small class="text-muted d-block">Effettua un ordine extra in questo giorno</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="exceptionType" id="exceptionTypeModify" value="modify">
                                        <label class="form-check-label" for="exceptionTypeModify">
                                            <i class="bi bi-pencil text-warning"></i>
                                            <strong>Modifica consegna</strong>
                                            <small class="text-muted d-block">Cambia il giorno di consegna per questo ordine</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3" id="deliveryOffsetSection" style="display: none;">
                                <label class="form-label">Consegna dopo quanti giorni?</label>
                                <div class="input-group" style="max-width: 200px;">
                                    <input type="number" class="form-control" id="exceptionDeliveryOffset" min="0" max="7" value="1">
                                    <span class="input-group-text">giorni</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="exceptionSkipSale">
                                    <label class="form-check-label" for="exceptionSkipSale">
                                        <i class="bi bi-tag text-info"></i>
                                        <strong>Salta prodotti in promozione</strong>
                                        <small class="text-muted d-block">Non ordinare prodotti attualmente in offerta</small>
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nota (opzionale)</label>
                                <input type="text" class="form-control" id="exceptionNote" placeholder="Es: Natale, Ferragosto, Chiusura straordinaria...">
                            </div>
                        </div>
                        <div class="exception-dialog-footer">
                            <button type="button" class="btn btn-outline-danger" id="removeExceptionBtn" style="display: none;">
                                <i class="bi bi-trash"></i> Rimuovi eccezione
                            </button>
                            <button type="button" class="btn btn-secondary" id="exceptionCancelBtn">Annulla</button>
                            <button type="button" class="btn btn-primary" id="saveExceptionBtn">
                                <i class="bi bi-check"></i> Salva
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Day names for display
const dayNames = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
const dayNamesShort = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];

// Get delivery day name based on order day and offset
function getDeliveryDay(orderDayIndex, offset) {
    const deliveryDayIndex = (orderDayIndex + offset) % 7;
    return dayNames[deliveryDayIndex];
}

// Calculate coverage for a specific order day
function calculateCoverage(orderDayIndex, orderDays, deliveryOffsets) {
    if (orderDays.length === 0) return 0;
    if (orderDays.length === 1) return 9;
    
    // Find next order day
    let nextOrderDay = null;
    for (let day of orderDays) {
        if (day > orderDayIndex) {
            nextOrderDay = day;
            break;
        }
    }
    
    // Wrap to next week if needed
    if (nextOrderDay === null) {
        nextOrderDay = orderDays[0] + 7;
    }
    
    // Get delivery offset for next order
    const nextDeliveryOffset = deliveryOffsets[nextOrderDay % 7];
    
    // Coverage = (next_order_day + next_delivery_offset) - order_day_index + 1
    const coverage = (nextOrderDay + nextDeliveryOffset) - orderDayIndex + 1;
    
    return coverage;
}

// Update the visual weekly calendar
function updateWeeklyCalendar() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    // Reset all calendar days
    days.forEach(day => {
        const dayEl = document.querySelector(`#weeklyCalendar [data-day="${day}"]`);
        if (dayEl) {
            dayEl.style.backgroundColor = '';
            const iconsEl = dayEl.querySelector('.calendar-icons');
            if (iconsEl) iconsEl.innerHTML = '';
        }
    });

    // Track deliveries per day
    const deliveriesPerDay = {};
    days.forEach(day => deliveriesPerDay[day] = []);

    // Find order days and their deliveries
    days.forEach((day, index) => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const offsetInput = document.querySelector(`input[name="${day}_delivery_offset"]`);

        if (checkbox && checkbox.checked) {
            // Mark order day
            const dayEl = document.querySelector(`#weeklyCalendar [data-day="${day}"]`);
            if (dayEl) {
                dayEl.style.backgroundColor = 'rgba(13, 110, 253, 0.15)';
                const iconsEl = dayEl.querySelector('.calendar-icons');
                if (iconsEl) {
                    iconsEl.innerHTML = '<i class="bi bi-cart-fill text-primary" style="font-size: 1.2rem;" title="Ordine"></i>';
                }
            }

            // Calculate delivery day
            if (offsetInput) {
                const offset = parseInt(offsetInput.value) || 1;
                const deliveryDayIndex = (index + offset) % 7;
                const deliveryDay = days[deliveryDayIndex];
                deliveriesPerDay[deliveryDay].push(dayNames[index]);
            }
        }
    });

    // Mark delivery days
    days.forEach(day => {
        if (deliveriesPerDay[day].length > 0) {
            const dayEl = document.querySelector(`#weeklyCalendar [data-day="${day}"]`);
            if (dayEl) {
                const iconsEl = dayEl.querySelector('.calendar-icons');
                const existingIcon = iconsEl.innerHTML;
                const tooltip = 'Consegna ordine: ' + deliveriesPerDay[day].join(', ');

                if (existingIcon.includes('bi-cart-fill')) {
                    // Both order and delivery on same day
                    dayEl.style.backgroundColor = 'rgba(25, 135, 84, 0.2)';
                    iconsEl.innerHTML = `<div><i class="bi bi-cart-fill text-primary" style="font-size: 1.1rem;" title="Ordine"></i></div>
                                         <div><i class="bi bi-truck text-success" style="font-size: 1.1rem;" title="${tooltip}"></i></div>`;
                } else {
                    dayEl.style.backgroundColor = 'rgba(25, 135, 84, 0.15)';
                    iconsEl.innerHTML = `<i class="bi bi-truck text-success" style="font-size: 1.2rem;" title="${tooltip}"></i>`;
                }
            }
        }
    });
}

// Update delivery day badges and coverage preview
function updateCoveragePreview() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    
    // Get selected order days and their offsets
    const orderDays = [];
    const deliveryOffsets = {};
    
    days.forEach((day, index) => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const offsetInput = document.querySelector(`input[name="${day}_delivery_offset"]`);
        
        if (checkbox && checkbox.checked) {
            orderDays.push(index);
        }
        
        if (offsetInput) {
            const offset = parseInt(offsetInput.value) || 1;
            deliveryOffsets[index] = offset;
            
            // Update delivery day badge
            const badge = document.getElementById(`delivery_${day}`);
            if (badge) {
                if (checkbox && checkbox.checked) {
                    const deliveryDay = getDeliveryDay(index, offset);
                    if (offset === 0) {
                        badge.textContent = `Stesso giorno`;
                        badge.className = 'badge bg-success';
                    } else {
                        badge.textContent = deliveryDay;
                        badge.className = 'badge bg-info';
                    }
                } else {
                    badge.textContent = '-';
                    badge.className = 'badge bg-secondary';
                }
            }
        }
    });
    
    // Show/hide coverage preview
    const preview = document.getElementById('coveragePreview');
    const display = document.getElementById('coverageDisplay');
    
    if (orderDays.length === 0) {
        preview.style.display = 'none';
        return;
    }
    
    // Build coverage table
    let html = '<table class="table table-sm mb-0"><thead><tr><th>Giorno ordine</th><th>Giorno consegna</th><th>Copertura</th><th>Dettagli</th></tr></thead><tbody>';
    
    orderDays.forEach(orderDayIdx => {
        const offset = deliveryOffsets[orderDayIdx];
        const deliveryDay = getDeliveryDay(orderDayIdx, offset);
        const coverage = calculateCoverage(orderDayIdx, orderDays, deliveryOffsets);
        
        // Find next order for explanation
        let nextOrderIdx = null;
        for (let day of orderDays) {
            if (day > orderDayIdx) {
                nextOrderIdx = day;
                break;
            }
        }
        if (nextOrderIdx === null) {
            nextOrderIdx = orderDays[0];
        }
        
        const nextDeliveryOffset = deliveryOffsets[nextOrderIdx];
        const nextDeliveryDay = getDeliveryDay(nextOrderIdx, nextDeliveryOffset);
        
        const explanation = `Fino alla consegna di ${dayNamesShort[nextOrderIdx]} (${nextDeliveryDay})`;
        
        html += `<tr>
            <td><strong>${dayNames[orderDayIdx]}</strong></td>
            <td>${offset === 0 ? '<span class="badge bg-success">Stesso giorno</span>' : deliveryDay}</td>
            <td><span class="badge bg-primary">${coverage} giorni</span></td>
            <td><small class="text-muted">${explanation}</small></td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    display.innerHTML = html;
    preview.style.display = 'block';
}

// Update card styling based on enabled state
function updateCardStyles() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    days.forEach(day => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const card = document.getElementById(`card_${day}`);
        const deliveryConfig = card?.querySelector('.delivery-config');

        if (card && checkbox) {
            if (checkbox.checked) {
                card.classList.add('border-primary');
                card.style.borderWidth = '2px';
                if (deliveryConfig) deliveryConfig.style.display = 'block';
            } else {
                card.classList.remove('border-primary');
                card.style.borderWidth = '1px';
                if (deliveryConfig) deliveryConfig.style.display = 'none';
            }
        }
    });
}

// Sync offset from UI elements (radio or custom input)
function syncOffsetFromUI(day) {
    const hiddenInput = document.querySelector(`input[name="${day}_delivery_offset"]`);
    const customToggle = document.getElementById(`${day}_custom_toggle`);
    const customDaysInput = document.getElementById(`${day}_custom_days`);

    if (!hiddenInput) return;

    if (customToggle && customToggle.checked && customDaysInput) {
        // Use custom value
        hiddenInput.value = parseInt(customDaysInput.value) || 2;
    } else {
        // Use radio button value
        const selectedRadio = document.querySelector(`input[name="${day}_offset_radio"]:checked`);
        if (selectedRadio) {
            hiddenInput.value = selectedRadio.value;
        }
    }
}

// Update custom delay UI visibility
function updateCustomDelayUI(day) {
    const customToggle = document.getElementById(`${day}_custom_toggle`);
    const customDaysInput = document.getElementById(`${day}_custom_days`);
    const customLabel = customDaysInput?.nextElementSibling;
    const radioButtons = document.querySelectorAll(`input[name="${day}_offset_radio"]`);

    if (customToggle && customDaysInput) {
        if (customToggle.checked) {
            customDaysInput.style.display = 'inline-block';
            if (customLabel) customLabel.style.display = 'inline';
            // Disable radio buttons visually
            radioButtons.forEach(radio => {
                radio.disabled = true;
                radio.closest('.btn-group')?.classList.add('opacity-50');
            });
        } else {
            customDaysInput.style.display = 'none';
            if (customLabel) customLabel.style.display = 'none';
            // Enable radio buttons
            radioButtons.forEach(radio => {
                radio.disabled = false;
                radio.closest('.btn-group')?.classList.remove('opacity-50');
            });
        }
    }
}

// Sync UI from hidden offset inputs (on page load)
function syncUIFromOffset(day) {
    const hiddenInput = document.querySelector(`input[name="${day}_delivery_offset"]`);
    const customToggle = document.getElementById(`${day}_custom_toggle`);
    const customDaysInput = document.getElementById(`${day}_custom_days`);

    if (hiddenInput) {
        const value = parseInt(hiddenInput.value) || 1;

        if (value === 0 || value === 1) {
            // Standard value - use radio button
            const radio = document.getElementById(`${day}_offset_${value}`);
            if (radio) radio.checked = true;
            if (customToggle) customToggle.checked = false;
        } else {
            // Custom value (>= 2)
            if (customToggle) customToggle.checked = true;
            if (customDaysInput) customDaysInput.value = value;
            // Default radio to "giorno seguente"
            const defaultRadio = document.getElementById(`${day}_offset_1`);
            if (defaultRadio) defaultRadio.checked = true;
        }

        updateCustomDelayUI(day);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    days.forEach(day => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const offsetInput = document.querySelector(`input[name="${day}_delivery_offset"]`);
        const customToggle = document.getElementById(`${day}_custom_toggle`);
        const customDaysInput = document.getElementById(`${day}_custom_days`);

        // Sync UI from saved values
        syncUIFromOffset(day);

        // Checkbox change event
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                updateCardStyles();
                updateCoveragePreview();
                updateWeeklyCalendar();
            });
        }

        // Hidden offset input change (for backwards compatibility)
        if (offsetInput) {
            offsetInput.addEventListener('input', function() {
                updateCoveragePreview();
                updateWeeklyCalendar();
            });
        }

        // Radio button change events for offset selection
        [0, 1].forEach(offset => {
            const radio = document.getElementById(`${day}_offset_${offset}`);
            if (radio) {
                radio.addEventListener('change', function() {
                    syncOffsetFromUI(day);
                    updateCoveragePreview();
                    updateWeeklyCalendar();
                });
            }
        });

        // Custom toggle change event
        if (customToggle) {
            customToggle.addEventListener('change', function() {
                updateCustomDelayUI(day);
                syncOffsetFromUI(day);
                updateCoveragePreview();
                updateWeeklyCalendar();
            });
        }

        // Custom days input change event
        if (customDaysInput) {
            customDaysInput.addEventListener('input', function() {
                syncOffsetFromUI(day);
                updateCoveragePreview();
                updateWeeklyCalendar();
            });
        }
    });

    // Initial update
    updateCardStyles();
    updateCoveragePreview();
    updateWeeklyCalendar();

    // Initialize 3-month calendar
    initThreeMonthCalendar();
});

// ========================================
// 3-MONTH CALENDAR FUNCTIONALITY
// ========================================

const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                    'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
const weekdayNamesShort = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];

// Store exceptions locally (will be synced with server)
let scheduleExceptions = {};  // { 'YYYY-MM-DD': { type: 'skip'|'add'|'modify', offset: number, note: string } }
let calendarStartMonth = new Date();  // First month to display

// Load existing exceptions from server
async function loadExceptions() {
    try {
        const response = await fetch('{% url "schedule-exceptions-api" storage_id=storage.id %}');
        if (response.ok) {
            const data = await response.json();
            scheduleExceptions = {};
            data.exceptions.forEach(exc => {
                scheduleExceptions[exc.date] = {
                    type: exc.exception_type,
                    offset: exc.delivery_offset,
                    skip_sale: exc.skip_sale || false,
                    note: exc.note
                };
            });
            renderThreeMonthCalendar();
        }
    } catch (e) {
        console.error('Error loading exceptions:', e);
    }
}

// Save exception to server
async function saveException(date, exceptionType, deliveryOffset, skipSale, note) {
    try {
        const response = await fetch('{% url "schedule-exceptions-api" storage_id=storage.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                date: date,
                exception_type: exceptionType,
                delivery_offset: deliveryOffset,
                skip_sale: skipSale,
                note: note
            })
        });
        return response.ok;
    } catch (e) {
        console.error('Error saving exception:', e);
        return false;
    }
}

// Delete exception from server
async function deleteException(date) {
    try {
        const response = await fetch('{% url "schedule-exceptions-api" storage_id=storage.id %}', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ date: date })
        });
        return response.ok;
    } catch (e) {
        console.error('Error deleting exception:', e);
        return false;
    }
}

// Get the weekly schedule from the form
function getWeeklySchedule() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const schedule = {};

    days.forEach((day, index) => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const offsetInput = document.querySelector(`input[name="${day}_delivery_offset"]`);

        schedule[index] = {
            isOrderDay: checkbox ? checkbox.checked : false,
            deliveryOffset: offsetInput ? parseInt(offsetInput.value) || 1 : 1
        };
    });

    return schedule;
}

// Check if a date is an order day (based on weekly schedule + exceptions)
function isOrderDay(date) {
    const dateStr = formatDate(date);
    const exception = scheduleExceptions[dateStr];
    const weekday = (date.getDay() + 6) % 7;  // Convert to Monday=0
    const weeklySchedule = getWeeklySchedule();

    if (exception) {
        if (exception.type === 'skip') return false;
        if (exception.type === 'add') return true;
        // 'modify' keeps it as order day
    }

    return weeklySchedule[weekday]?.isOrderDay || false;
}

// Get delivery offset for a date
function getDeliveryOffsetForDate(date) {
    const dateStr = formatDate(date);
    const exception = scheduleExceptions[dateStr];
    const weekday = (date.getDay() + 6) % 7;
    const weeklySchedule = getWeeklySchedule();

    if (exception && (exception.type === 'add' || exception.type === 'modify') && exception.offset !== null) {
        return exception.offset;
    }

    return weeklySchedule[weekday]?.deliveryOffset || 1;
}

// Format date as YYYY-MM-DD
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Format date for display (DD/MM/YYYY)
function formatDateDisplay(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// Parse date from YYYY-MM-DD
function parseDate(dateStr) {
    const [year, month, day] = dateStr.split('-').map(Number);
    return new Date(year, month - 1, day);
}

// Generate calendar HTML for a single month
function generateMonthCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startWeekday = (firstDay.getDay() + 6) % 7;  // Monday = 0
    const deliveryDates = getDeliveryDatesForMonth(year, month);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let html = `
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-light py-2">
                    <h6 class="mb-0 text-center">${monthNames[month]} ${year}</h6>
                </div>
                <div class="card-body p-2">
                    <table class="table table-sm table-borderless mb-0 calendar-table">
                        <thead>
                            <tr class="text-center small text-muted">
                                <th>L</th><th>M</th><th>M</th><th>G</th><th>V</th><th>S</th><th>D</th>
                            </tr>
                        </thead>
                        <tbody>
    `;

    let dayCounter = 1;
    const totalDays = lastDay.getDate();

    // Generate weeks
    for (let week = 0; week < 6; week++) {
        if (dayCounter > totalDays) break;

        html += '<tr>';

        for (let weekday = 0; weekday < 7; weekday++) {
            if ((week === 0 && weekday < startWeekday) || dayCounter > totalDays) {
                html += '<td></td>';
            } else {
                const date = new Date(year, month, dayCounter);
                const dateStr = formatDate(date);
                const exception = scheduleExceptions[dateStr];
                const actuallyIsOrderDay = isOrderDay(date);
                const isDeliveryDay = deliveryDates.has(dateStr);
                const isPast = date < today;

                // Build dots HTML
                let dots = [];
                let titleParts = [];
                let cellClass = 'calendar-cell text-center';
                let clickAttr = '';

                if (isPast) {
                    cellClass += ' text-muted';
                } else {
                    cellClass += ' clickable-day';
                    clickAttr = `data-date="${dateStr}" style="cursor: pointer;"`;
                }

                // Check for exceptions first
                if (exception) {
                    if (exception.type === 'skip') {
                        dots.push('<span class="cal-dot bg-danger"></span>');
                    } else if (exception.type === 'add') {
                        dots.push('<span class="cal-dot bg-warning"></span>');
                    } else if (exception.type === 'modify') {
                        dots.push('<span class="cal-dot bg-primary"></span>');
                    }
                } else if (actuallyIsOrderDay) {
                    dots.push('<span class="cal-dot bg-primary"></span>');
                }

                // Add skip_sale indicator dot (info color)
                if (exception && exception.skip_sale) {
                    dots.push('<span class="cal-dot bg-info"></span>');
                }

                // Add delivery dot (can coexist with order dot)
                if (isDeliveryDay) {
                    dots.push('<span class="cal-dot bg-success"></span>');
                }

                const dotsHtml = dots.length > 0 ? `<div class="cal-dots">${dots.join('')}</div>` : '';

                html += `<td class="${cellClass}" ${clickAttr}>
                    <div class="cal-day-num">${dayCounter}</div>
                    ${dotsHtml}
                </td>`;

                dayCounter++;
            }
        }

        html += '</tr>';
    }

    html += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    return html;
}

// Get all delivery dates for a month (for highlighting)
function getDeliveryDatesForMonth(year, month) {
    const deliveryDates = new Set();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);

    // Check a range that includes the previous month (for deliveries that might land in this month)
    const checkStart = new Date(year, month - 1, 1);
    const checkEnd = lastDay;

    for (let d = new Date(checkStart); d <= checkEnd; d.setDate(d.getDate() + 1)) {
        if (isOrderDay(d)) {
            const offset = getDeliveryOffsetForDate(d);
            const deliveryDate = new Date(d);
            deliveryDate.setDate(deliveryDate.getDate() + offset);

            if (deliveryDate.getMonth() === month && deliveryDate.getFullYear() === year) {
                deliveryDates.add(formatDate(deliveryDate));
            }
        }
    }

    return deliveryDates;
}

// Render the 3-month calendar
function renderThreeMonthCalendar() {
    const container = document.getElementById('threeMonthCalendar');
    if (!container) return;

    let html = '';
    const startDate = new Date(calendarStartMonth.getFullYear(), calendarStartMonth.getMonth(), 1);

    for (let i = 0; i < 3; i++) {
        const monthDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
        html += generateMonthCalendar(monthDate.getFullYear(), monthDate.getMonth());
    }

    container.innerHTML = html;

    // Update navigation label
    const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 2, 1);
    document.getElementById('calendarCurrentRange').textContent =
        `${monthNames[startDate.getMonth()]} - ${monthNames[endDate.getMonth()]} ${endDate.getFullYear()}`;
}

// Initialize the 3-month calendar
function showExceptionDialog() {
    document.getElementById('exceptionOverlay').style.display = 'flex';
}

function hideExceptionDialog() {
    document.getElementById('exceptionOverlay').style.display = 'none';
}

function initThreeMonthCalendar() {
    // Set start month to current month
    calendarStartMonth = new Date();
    calendarStartMonth.setDate(1);

    // Event delegation for calendar day clicks
    const calendarContainer = document.getElementById('threeMonthCalendar');
    if (calendarContainer) {
        calendarContainer.addEventListener('click', function(e) {
            const dayCell = e.target.closest('.clickable-day');
            if (dayCell) {
                const dateStr = dayCell.dataset.date;
                if (dateStr) {
                    openExceptionModal(dateStr);
                }
            }
        });
    }

    // Close dialog buttons
    document.getElementById('exceptionCloseBtn')?.addEventListener('click', hideExceptionDialog);
    document.getElementById('exceptionCancelBtn')?.addEventListener('click', hideExceptionDialog);

    // Close on overlay click (outside dialog)
    document.getElementById('exceptionOverlay')?.addEventListener('click', function(e) {
        if (e.target === this) hideExceptionDialog();
    });

    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('exceptionOverlay').style.display === 'flex') {
            hideExceptionDialog();
        }
    });

    // Navigation buttons
    document.getElementById('calendarPrevMonth')?.addEventListener('click', () => {
        calendarStartMonth.setMonth(calendarStartMonth.getMonth() - 1);
        renderThreeMonthCalendar();
    });

    document.getElementById('calendarNextMonth')?.addEventListener('click', () => {
        calendarStartMonth.setMonth(calendarStartMonth.getMonth() + 1);
        renderThreeMonthCalendar();
    });

    // Exception type radio buttons - show/hide delivery offset
    document.querySelectorAll('input[name="exceptionType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const offsetSection = document.getElementById('deliveryOffsetSection');
            if (this.value === 'add' || this.value === 'modify') {
                offsetSection.style.display = 'block';
            } else {
                offsetSection.style.display = 'none';
            }
        });
    });

    // Save exception button
    document.getElementById('saveExceptionBtn')?.addEventListener('click', async () => {
        const dateStr = document.getElementById('exceptionDateInput').value;
        const exceptionType = document.querySelector('input[name="exceptionType"]:checked').value;
        const deliveryOffset = parseInt(document.getElementById('exceptionDeliveryOffset').value) || 1;
        const skipSale = document.getElementById('exceptionSkipSale').checked;
        const note = document.getElementById('exceptionNote').value.trim();

        const success = await saveException(dateStr, exceptionType, deliveryOffset, skipSale, note);
        if (success) {
            scheduleExceptions[dateStr] = {
                type: exceptionType,
                offset: (exceptionType === 'add' || exceptionType === 'modify') ? deliveryOffset : null,
                skip_sale: skipSale,
                note: note
            };
            renderThreeMonthCalendar();
            hideExceptionDialog();
        } else {
            alert('Errore nel salvare l\'eccezione. Riprova.');
        }
    });

    // Remove exception button
    document.getElementById('removeExceptionBtn')?.addEventListener('click', async () => {
        const dateStr = document.getElementById('exceptionDateInput').value;
        const success = await deleteException(dateStr);
        if (success) {
            delete scheduleExceptions[dateStr];
            renderThreeMonthCalendar();
            hideExceptionDialog();
        } else {
            alert('Errore nel rimuovere l\'eccezione. Riprova.');
        }
    });

    // Load exceptions and render
    loadExceptions();
}

// Open exception dialog for a specific date
function openExceptionModal(dateStr) {
    const date = parseDate(dateStr);
    const exception = scheduleExceptions[dateStr];
    const weekday = (date.getDay() + 6) % 7;
    const weeklySchedule = getWeeklySchedule();
    const isScheduledOrderDay = weeklySchedule[weekday]?.isOrderDay || false;

    // Set date
    document.getElementById('exceptionModalDate').textContent = formatDateDisplay(date) + ' (' + dayNames[weekday] + ')';
    document.getElementById('exceptionDateInput').value = dateStr;

    // Reset form
    document.getElementById('exceptionNote').value = '';
    document.getElementById('exceptionDeliveryOffset').value = weeklySchedule[weekday]?.deliveryOffset || 1;
    document.getElementById('exceptionSkipSale').checked = false;

    if (exception) {
        document.getElementById('removeExceptionBtn').style.display = 'inline-block';
        document.querySelector(`input[name="exceptionType"][value="${exception.type}"]`).checked = true;
        if (exception.note) {
            document.getElementById('exceptionNote').value = exception.note;
        }
        if (exception.offset !== null) {
            document.getElementById('exceptionDeliveryOffset').value = exception.offset;
        }
        document.getElementById('exceptionSkipSale').checked = exception.skip_sale || false;
    } else {
        document.getElementById('removeExceptionBtn').style.display = 'none';
        if (isScheduledOrderDay) {
            document.getElementById('exceptionTypeSkip').checked = true;
        } else {
            document.getElementById('exceptionTypeAdd').checked = true;
        }
    }

    // Update visibility of delivery offset section
    const selectedType = document.querySelector('input[name="exceptionType"]:checked').value;
    document.getElementById('deliveryOffsetSection').style.display =
        (selectedType === 'add' || selectedType === 'modify') ? 'block' : 'none';

    showExceptionDialog();
}

// Update 3-month calendar when weekly schedule changes
function updateThreeMonthCalendar() {
    renderThreeMonthCalendar();
}

// Add listener to update calendar when weekly schedule changes
document.querySelectorAll('input[name$="_delivery_offset"], input[type="checkbox"][name]').forEach(input => {
    if (input.name && !input.name.includes('exception')) {
        input.addEventListener('change', updateThreeMonthCalendar);
    }
});
</script>
{% endblock %}