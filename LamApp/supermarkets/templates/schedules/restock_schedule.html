<!-- LamApp/supermarkets/templates/restock_schedule.html -->
{% extends "base.html" %}
{% block title %}Schedule - {{ storage.name }}{% endblock %}
{% block page_title %}Restock Schedule{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'supermarket-detail' pk=storage.supermarket.id %}">{{ storage.supermarket.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'storage-detail' pk=storage.id %}">{{ storage.name }}</a></li>
                    <li class="breadcrumb-item active">Schedule</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="stat-card">
                <h4 class="mb-4">
                    <i class="bi bi-calendar-check text-primary"></i>
                    Configure Restock Schedule
                </h4>

                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> How It Works</h6>
                    <ul class="mb-0">
                        <li><strong>Order Days:</strong> Select which days to place orders</li>
                        <li><strong>Timing:</strong> Orders run at 6:00 AM on order days</li>
                        <li><strong>Delivery:</strong> Arrives the day after ordering</li>
                        <li><strong>Coverage:</strong> Automatically calculated (days until next order)</li>
                    </ul>
                </div>

                <form method="post" id="scheduleForm">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <h5 class="mb-3">Select Order Days</h5>
                        <p class="text-muted small">Check the days when you want to place orders:</p>
                        
                        <div class="row">
                            {% for field in form %}
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    {{ field }}
                                    <label class="form-check-label" for="{{ field.id_for_label }}">
                                        <strong>{{ field.label }}</strong>
                                        <br><small class="text-muted">{{ field.help_text }}</small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Coverage Preview -->
                    <div id="coveragePreview" class="alert alert-secondary mb-4" style="display: none;">
                        <h6>Coverage Preview</h6>
                        <div id="coverageDisplay"></div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{% url 'storage-detail' pk=storage.id %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Save Schedule
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// Calculate and display coverage preview when days are selected
document.getElementById('scheduleForm').addEventListener('change', function(e) {
    if (e.target.type === 'checkbox') {
        updateCoveragePreview();
    }
});

function updateCoveragePreview() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    // Get selected days
    const orderDays = [];
    days.forEach((day, index) => {
        const checkbox = document.getElementById('id_' + day);
        if (checkbox && checkbox.checked) {
            orderDays.push(index);
        }
    });
    
    const preview = document.getElementById('coveragePreview');
    const display = document.getElementById('coverageDisplay');
    
    if (orderDays.length === 0) {
        preview.style.display = 'none';
        return;
    }
    
    // Calculate coverage for each order day
    let html = '<table class="table table-sm mb-0"><thead><tr><th>Order Day</th><th>Delivery Day</th><th>Coverage</th></tr></thead><tbody>';
    
    orderDays.forEach(orderDay => {
        const deliveryDay = (orderDay + 1) % 7;
        const coverage = calculateCoverage(orderDay, orderDays);
        
        html += `<tr>
            <td><strong>${dayNames[orderDay]}</strong></td>
            <td>${dayNames[deliveryDay]}</td>
            <td><span class="badge bg-primary">${coverage} days</span></td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    display.innerHTML = html;
    preview.style.display = 'block';
}

function calculateCoverage(orderDay, orderDays) {
    if (orderDays.length === 1) {
        return 9;
    }
    
    // Find next order day
    let nextOrderDay = null;
    for (let day of orderDays) {
        if (day > orderDay) {
            nextOrderDay = day;
            break;
        }
    }
    
    if (nextOrderDay === null) {
        nextOrderDay = orderDays[0] + 7;
    }
    
    return nextOrderDay - orderDay + 2;
}

// Show preview on page load if days are already selected
document.addEventListener('DOMContentLoaded', updateCoveragePreview);
</script>
{% endblock %}


