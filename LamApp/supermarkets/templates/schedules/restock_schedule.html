<!-- LamApp/supermarkets/templates/schedules/restock_schedule.html -->
{% extends "base.html" %}
{% block title %}Agenda ordini - {{ storage.name }}{% endblock %}
{% block page_title %}Agenda ordini{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'supermarket-detail' pk=storage.supermarket.id %}">{{ storage.supermarket.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'storage-detail' pk=storage.id %}">{{ storage.name }}</a></li>
                    <li class="breadcrumb-item active">Agenda ordini</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <div class="stat-card">
                <h4 class="mb-4">
                    <i class="bi bi-calendar-check text-primary"></i>
                    Configura Agenda ordini
                </h4>

                <!-- Visual Weekly Calendar Preview -->
                <div class="card mb-4 border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-eye"></i> Anteprima Settimanale
                        </h6>
                        <div class="d-flex justify-content-between gap-1" id="weeklyCalendar">
                            <div class="text-center flex-fill p-2 rounded" data-day="monday" style="min-width: 13%;">
                                <div class="fw-bold small">Lun</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="tuesday" style="min-width: 13%;">
                                <div class="fw-bold small">Mar</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="wednesday" style="min-width: 13%;">
                                <div class="fw-bold small">Mer</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="thursday" style="min-width: 13%;">
                                <div class="fw-bold small">Gio</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="friday" style="min-width: 13%;">
                                <div class="fw-bold small">Ven</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="saturday" style="min-width: 13%;">
                                <div class="fw-bold small">Sab</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                            <div class="text-center flex-fill p-2 rounded" data-day="sunday" style="min-width: 13%;">
                                <div class="fw-bold small">Dom</div>
                                <div class="calendar-icons mt-1" style="min-height: 50px;"></div>
                            </div>
                        </div>
                        <div class="mt-3 d-flex gap-3 justify-content-center small">
                            <span><i class="bi bi-cart-fill text-primary"></i> Giorno ordine</span>
                            <span><i class="bi bi-truck text-success"></i> Giorno consegna</span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Come funziona</h6>
                    <ul class="mb-0">
                        <li><strong>Giorni di ordine:</strong> Seleziona i giorni in cui effettuare gli ordini</li>
                        <li><strong>Tempi di consegna:</strong> Configura quando arriva la consegna (0=lo stesso giorno, 1=il giorno successivo, 2=due giorni dopo)</li>
                        <li><strong>Copertura:</strong> Calcolato automaticamente dal giorno dell'ordine al giorno di consegna successivo</li>
                        <li><strong>Tempistiche:</strong> Gli ordini vengono eseguiti alle 6:00 nei giorni degli ordini</li>
                    </ul>
                </div>

                <form method="post" id="scheduleForm">
                    {% csrf_token %}

                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="bi bi-calendar-plus text-primary"></i>
                            Seleziona i giorni di ordine
                        </h5>
                        <p class="text-muted small mb-3">Clicca su un giorno per abilitare/disabilitare l'ordine, poi scegli quando arriva la consegna:</p>

                        <!-- Day Cards Grid -->
                        <div class="row g-3">
                            <!-- Monday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="monday" id="card_monday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Lunedì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.monday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-1">Consegna dopo:</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="monday_offset_radio" id="monday_offset_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm" for="monday_offset_0">Stesso giorno</label>
                                                <input type="radio" class="btn-check" name="monday_offset_radio" id="monday_offset_1" value="1" checked>
                                                <label class="btn btn-outline-secondary btn-sm" for="monday_offset_1">+1 giorno</label>
                                                <input type="radio" class="btn-check" name="monday_offset_radio" id="monday_offset_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm" for="monday_offset_2">+2 giorni</label>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_monday">Martedì</span>
                                            </div>
                                            {{ form.monday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Tuesday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="tuesday" id="card_tuesday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Martedì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.tuesday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-1">Consegna dopo:</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="tuesday_offset_radio" id="tuesday_offset_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm" for="tuesday_offset_0">Stesso giorno</label>
                                                <input type="radio" class="btn-check" name="tuesday_offset_radio" id="tuesday_offset_1" value="1" checked>
                                                <label class="btn btn-outline-secondary btn-sm" for="tuesday_offset_1">+1 giorno</label>
                                                <input type="radio" class="btn-check" name="tuesday_offset_radio" id="tuesday_offset_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm" for="tuesday_offset_2">+2 giorni</label>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_tuesday">Mercoledì</span>
                                            </div>
                                            {{ form.tuesday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Wednesday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="wednesday" id="card_wednesday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Mercoledì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.wednesday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-1">Consegna dopo:</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="wednesday_offset_radio" id="wednesday_offset_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm" for="wednesday_offset_0">Stesso giorno</label>
                                                <input type="radio" class="btn-check" name="wednesday_offset_radio" id="wednesday_offset_1" value="1" checked>
                                                <label class="btn btn-outline-secondary btn-sm" for="wednesday_offset_1">+1 giorno</label>
                                                <input type="radio" class="btn-check" name="wednesday_offset_radio" id="wednesday_offset_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm" for="wednesday_offset_2">+2 giorni</label>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_wednesday">Giovedì</span>
                                            </div>
                                            {{ form.wednesday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Thursday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="thursday" id="card_thursday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Giovedì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.thursday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-1">Consegna dopo:</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="thursday_offset_radio" id="thursday_offset_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm" for="thursday_offset_0">Stesso giorno</label>
                                                <input type="radio" class="btn-check" name="thursday_offset_radio" id="thursday_offset_1" value="1" checked>
                                                <label class="btn btn-outline-secondary btn-sm" for="thursday_offset_1">+1 giorno</label>
                                                <input type="radio" class="btn-check" name="thursday_offset_radio" id="thursday_offset_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm" for="thursday_offset_2">+2 giorni</label>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_thursday">Venerdì</span>
                                            </div>
                                            {{ form.thursday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Friday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="friday" id="card_friday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Venerdì
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.friday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-1">Consegna dopo:</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="friday_offset_radio" id="friday_offset_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm" for="friday_offset_0">Stesso giorno</label>
                                                <input type="radio" class="btn-check" name="friday_offset_radio" id="friday_offset_1" value="1" checked>
                                                <label class="btn btn-outline-secondary btn-sm" for="friday_offset_1">+1 giorno</label>
                                                <input type="radio" class="btn-check" name="friday_offset_radio" id="friday_offset_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm" for="friday_offset_2">+2 giorni</label>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_friday">Sabato</span>
                                            </div>
                                            {{ form.friday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Saturday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="saturday" id="card_saturday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Sabato
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.saturday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-1">Consegna dopo:</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="saturday_offset_radio" id="saturday_offset_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm" for="saturday_offset_0">Stesso giorno</label>
                                                <input type="radio" class="btn-check" name="saturday_offset_radio" id="saturday_offset_1" value="1" checked>
                                                <label class="btn btn-outline-secondary btn-sm" for="saturday_offset_1">+1 giorno</label>
                                                <input type="radio" class="btn-check" name="saturday_offset_radio" id="saturday_offset_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm" for="saturday_offset_2">+2 giorni</label>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_saturday">Domenica</span>
                                            </div>
                                            {{ form.saturday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Sunday -->
                            <div class="col-md-6 col-lg-4">
                                <div class="card day-card h-100" data-day="sunday" id="card_sunday">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="bi bi-calendar-day"></i> Domenica
                                            </h6>
                                            <div class="form-check form-switch">
                                                {{ form.sunday }}
                                            </div>
                                        </div>
                                        <div class="delivery-config mt-3" style="display: none;">
                                            <label class="form-label small text-muted mb-1">Consegna dopo:</label>
                                            <div class="btn-group w-100" role="group">
                                                <input type="radio" class="btn-check" name="sunday_offset_radio" id="sunday_offset_0" value="0">
                                                <label class="btn btn-outline-secondary btn-sm" for="sunday_offset_0">Stesso giorno</label>
                                                <input type="radio" class="btn-check" name="sunday_offset_radio" id="sunday_offset_1" value="1" checked>
                                                <label class="btn btn-outline-secondary btn-sm" for="sunday_offset_1">+1 giorno</label>
                                                <input type="radio" class="btn-check" name="sunday_offset_radio" id="sunday_offset_2" value="2">
                                                <label class="btn btn-outline-secondary btn-sm" for="sunday_offset_2">+2 giorni</label>
                                            </div>
                                            <div class="mt-2 text-center">
                                                <small class="text-muted">Consegna: </small>
                                                <span class="badge bg-success" id="delivery_sunday">Lunedì</span>
                                            </div>
                                            {{ form.sunday_delivery_offset }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coverage Preview -->
                    <div id="coveragePreview" class="alert alert-secondary mb-4" style="display: none;">
                        <h6><i class="bi bi-calculator"></i> Anteprima della copertura</h6>
                        <div id="coverageDisplay"></div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{% url 'storage-detail' pk=storage.id %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Annulla
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Salva agenda ordini
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Day names for display
const dayNames = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
const dayNamesShort = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];

// Get delivery day name based on order day and offset
function getDeliveryDay(orderDayIndex, offset) {
    const deliveryDayIndex = (orderDayIndex + offset) % 7;
    return dayNames[deliveryDayIndex];
}

// Calculate coverage for a specific order day
function calculateCoverage(orderDayIndex, orderDays, deliveryOffsets) {
    if (orderDays.length === 0) return 0;
    if (orderDays.length === 1) return 9;
    
    // Find next order day
    let nextOrderDay = null;
    for (let day of orderDays) {
        if (day > orderDayIndex) {
            nextOrderDay = day;
            break;
        }
    }
    
    // Wrap to next week if needed
    if (nextOrderDay === null) {
        nextOrderDay = orderDays[0] + 7;
    }
    
    // Get delivery offset for next order
    const nextDeliveryOffset = deliveryOffsets[nextOrderDay % 7];
    
    // Coverage = (next_order_day + next_delivery_offset) - order_day_index + 1
    const coverage = (nextOrderDay + nextDeliveryOffset) - orderDayIndex + 1;
    
    return coverage;
}

// Update the visual weekly calendar
function updateWeeklyCalendar() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    // Reset all calendar days
    days.forEach(day => {
        const dayEl = document.querySelector(`#weeklyCalendar [data-day="${day}"]`);
        if (dayEl) {
            dayEl.style.backgroundColor = '';
            const iconsEl = dayEl.querySelector('.calendar-icons');
            if (iconsEl) iconsEl.innerHTML = '';
        }
    });

    // Track deliveries per day
    const deliveriesPerDay = {};
    days.forEach(day => deliveriesPerDay[day] = []);

    // Find order days and their deliveries
    days.forEach((day, index) => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const offsetInput = document.querySelector(`input[name="${day}_delivery_offset"]`);

        if (checkbox && checkbox.checked) {
            // Mark order day
            const dayEl = document.querySelector(`#weeklyCalendar [data-day="${day}"]`);
            if (dayEl) {
                dayEl.style.backgroundColor = 'rgba(13, 110, 253, 0.15)';
                const iconsEl = dayEl.querySelector('.calendar-icons');
                if (iconsEl) {
                    iconsEl.innerHTML = '<i class="bi bi-cart-fill text-primary" style="font-size: 1.2rem;" title="Ordine"></i>';
                }
            }

            // Calculate delivery day
            if (offsetInput) {
                const offset = parseInt(offsetInput.value) || 1;
                const deliveryDayIndex = (index + offset) % 7;
                const deliveryDay = days[deliveryDayIndex];
                deliveriesPerDay[deliveryDay].push(dayNames[index]);
            }
        }
    });

    // Mark delivery days
    days.forEach(day => {
        if (deliveriesPerDay[day].length > 0) {
            const dayEl = document.querySelector(`#weeklyCalendar [data-day="${day}"]`);
            if (dayEl) {
                const iconsEl = dayEl.querySelector('.calendar-icons');
                const existingIcon = iconsEl.innerHTML;
                const tooltip = 'Consegna ordine: ' + deliveriesPerDay[day].join(', ');

                if (existingIcon.includes('bi-cart-fill')) {
                    // Both order and delivery on same day
                    dayEl.style.backgroundColor = 'rgba(25, 135, 84, 0.2)';
                    iconsEl.innerHTML = `<div><i class="bi bi-cart-fill text-primary" style="font-size: 1.1rem;" title="Ordine"></i></div>
                                         <div><i class="bi bi-truck text-success" style="font-size: 1.1rem;" title="${tooltip}"></i></div>`;
                } else {
                    dayEl.style.backgroundColor = 'rgba(25, 135, 84, 0.15)';
                    iconsEl.innerHTML = `<i class="bi bi-truck text-success" style="font-size: 1.2rem;" title="${tooltip}"></i>`;
                }
            }
        }
    });
}

// Update delivery day badges and coverage preview
function updateCoveragePreview() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    
    // Get selected order days and their offsets
    const orderDays = [];
    const deliveryOffsets = {};
    
    days.forEach((day, index) => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const offsetInput = document.querySelector(`input[name="${day}_delivery_offset"]`);
        
        if (checkbox && checkbox.checked) {
            orderDays.push(index);
        }
        
        if (offsetInput) {
            const offset = parseInt(offsetInput.value) || 1;
            deliveryOffsets[index] = offset;
            
            // Update delivery day badge
            const badge = document.getElementById(`delivery_${day}`);
            if (badge) {
                if (checkbox && checkbox.checked) {
                    const deliveryDay = getDeliveryDay(index, offset);
                    if (offset === 0) {
                        badge.textContent = `Stesso giorno`;
                        badge.className = 'badge bg-success';
                    } else {
                        badge.textContent = deliveryDay;
                        badge.className = 'badge bg-info';
                    }
                } else {
                    badge.textContent = '-';
                    badge.className = 'badge bg-secondary';
                }
            }
        }
    });
    
    // Show/hide coverage preview
    const preview = document.getElementById('coveragePreview');
    const display = document.getElementById('coverageDisplay');
    
    if (orderDays.length === 0) {
        preview.style.display = 'none';
        return;
    }
    
    // Build coverage table
    let html = '<table class="table table-sm mb-0"><thead><tr><th>Giorno ordine</th><th>Giorno consegna</th><th>Copertura</th><th>Dettagli</th></tr></thead><tbody>';
    
    orderDays.forEach(orderDayIdx => {
        const offset = deliveryOffsets[orderDayIdx];
        const deliveryDay = getDeliveryDay(orderDayIdx, offset);
        const coverage = calculateCoverage(orderDayIdx, orderDays, deliveryOffsets);
        
        // Find next order for explanation
        let nextOrderIdx = null;
        for (let day of orderDays) {
            if (day > orderDayIdx) {
                nextOrderIdx = day;
                break;
            }
        }
        if (nextOrderIdx === null) {
            nextOrderIdx = orderDays[0];
        }
        
        const nextDeliveryOffset = deliveryOffsets[nextOrderIdx];
        const nextDeliveryDay = getDeliveryDay(nextOrderIdx, nextDeliveryOffset);
        
        const explanation = `Fino alla consegna di ${dayNamesShort[nextOrderIdx]} (${nextDeliveryDay})`;
        
        html += `<tr>
            <td><strong>${dayNames[orderDayIdx]}</strong></td>
            <td>${offset === 0 ? '<span class="badge bg-success">Stesso giorno</span>' : deliveryDay}</td>
            <td><span class="badge bg-primary">${coverage} giorni</span></td>
            <td><small class="text-muted">${explanation}</small></td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    display.innerHTML = html;
    preview.style.display = 'block';
}

// Update card styling based on enabled state
function updateCardStyles() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    days.forEach(day => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const card = document.getElementById(`card_${day}`);
        const deliveryConfig = card?.querySelector('.delivery-config');

        if (card && checkbox) {
            if (checkbox.checked) {
                card.classList.add('border-primary');
                card.style.borderWidth = '2px';
                if (deliveryConfig) deliveryConfig.style.display = 'block';
            } else {
                card.classList.remove('border-primary');
                card.style.borderWidth = '1px';
                if (deliveryConfig) deliveryConfig.style.display = 'none';
            }
        }
    });
}

// Sync radio buttons with hidden offset inputs
function syncOffsetFromRadio(day) {
    const selectedRadio = document.querySelector(`input[name="${day}_offset_radio"]:checked`);
    const hiddenInput = document.querySelector(`input[name="${day}_delivery_offset"]`);

    if (selectedRadio && hiddenInput) {
        hiddenInput.value = selectedRadio.value;
    }
}

// Sync radio buttons from hidden offset inputs (on page load)
function syncRadioFromOffset(day) {
    const hiddenInput = document.querySelector(`input[name="${day}_delivery_offset"]`);
    if (hiddenInput) {
        const value = parseInt(hiddenInput.value) || 1;
        // Clamp to 0, 1, or 2
        const clampedValue = Math.min(Math.max(value, 0), 2);
        const radio = document.getElementById(`${day}_offset_${clampedValue}`);
        if (radio) radio.checked = true;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

    days.forEach(day => {
        const checkbox = document.querySelector(`input[name="${day}"]`);
        const offsetInput = document.querySelector(`input[name="${day}_delivery_offset"]`);

        // Sync radio buttons from saved values
        syncRadioFromOffset(day);

        // Checkbox change event
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                updateCardStyles();
                updateCoveragePreview();
                updateWeeklyCalendar();
            });
        }

        // Hidden offset input change (for backwards compatibility)
        if (offsetInput) {
            offsetInput.addEventListener('input', function() {
                updateCoveragePreview();
                updateWeeklyCalendar();
            });
        }

        // Radio button change events for offset selection
        [0, 1, 2].forEach(offset => {
            const radio = document.getElementById(`${day}_offset_${offset}`);
            if (radio) {
                radio.addEventListener('change', function() {
                    syncOffsetFromRadio(day);
                    updateCoveragePreview();
                    updateWeeklyCalendar();
                });
            }
        });
    });

    // Initial update
    updateCardStyles();
    updateCoveragePreview();
    updateWeeklyCalendar();
});
</script>
{% endblock %}