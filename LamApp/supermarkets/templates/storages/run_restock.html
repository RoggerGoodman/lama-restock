<!-- LamApp/supermarkets/templates/storages/run_restock.html - ENHANCED -->
{% extends 'base.html' %}

{% block title %}Run Restock - {{ storage.name }}{% endblock %}
{% block page_title %}Run Manual Restock{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'supermarket-detail' pk=storage.supermarket.id %}">{{ storage.supermarket.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'storage-detail' pk=storage.id %}">{{ storage.name }}</a></li>
                    <li class="breadcrumb-item active">Run Restock</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="stat-card">
                <h4 class="mb-4">
                    <i class="bi bi-play-circle text-primary"></i>
                    Run Manual Restock Check
                </h4>

                <!-- Storage Info -->
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Storage Information</h6>
                    <p class="mb-1"><strong>Storage:</strong> {{ storage.name }}</p>
                    <p class="mb-1"><strong>Supermarket:</strong> {{ storage.supermarket.name }}</p>
                    <p class="mb-0"><strong>Settore:</strong> {{ storage.settore }}</p>
                </div>

                <!-- Warning -->
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle"></i> What This Will Do</h6>
                    <ol class="mb-0">
                        <li>Update product statistics from PAC2000A (5-10 minutes)</li>
                        <li>Calculate which products need to be ordered</li>
                        <li><strong>Place the actual order in the system</strong></li>
                    </ol>
                    <p class="mt-2 mb-0"><strong>Total estimated time: 10-15 minutes</strong></p>
                </div>

                <!-- Form (hidden after submission) -->
                <form method="post" id="restockForm">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="coverage" class="form-label">
                            <i class="bi bi-calendar-range"></i> Coverage (days)
                        </label>
                        <input 
                            type="number" 
                            class="form-control" 
                            id="coverage" 
                            name="coverage" 
                            step="0.5" 
                            min="0" 
                            max="30"
                            placeholder="Leave empty to use schedule calculation"
                        >
                        <div class="form-text">
                            {% if storage.schedule %}
                                Schedule will calculate coverage automatically based on next order day
                            {% else %}
                                <span class="text-warning">No schedule configured - you must specify coverage</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{% url 'storage-detail' pk=storage.id %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="bi bi-play-circle"></i> Run Restock Check
                        </button>
                    </div>
                </form>

                <!-- Progress indicator (hidden by default) -->
                <div id="progressContainer" class="mt-4" style="display: none;">
                    <h5 class="mb-3">
                        <i class="bi bi-hourglass-split"></i> Restock in Progress
                    </h5>
                    
                    <!-- Stage Details Text -->
                    <div class="alert alert-info mb-3" id="stageDetailsAlert">
                        <strong id="stageDetailsText">Initializing...</strong>
                    </div>
                    
                    <!-- Overall Progress Bar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="stageLabel">Initializing...</span>
                            <span class="text-muted" id="progressPercent">0%</span>
                        </div>
                        <div class="progress" style="height: 30px;">
                            <div 
                                id="progressBar" 
                                class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                role="progressbar" 
                                style="width: 0%">
                                0%
                            </div>
                        </div>
                    </div>

                    <!-- Stage Cards -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-0 bg-light" id="stage1Card">
                                <div class="card-body text-center">
                                    <i class="bi bi-download" style="font-size: 2rem;" id="stage1Icon"></i>
                                    <h6 class="mt-2 mb-1">Update Stats</h6>
                                    <small class="text-muted" id="stage1Status">Waiting...</small>
                                    <div id="stage1Time" class="text-muted small mt-1" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light" id="stage2Card">
                                <div class="card-body text-center">
                                    <i class="bi bi-calculator" style="font-size: 2rem;" id="stage2Icon"></i>
                                    <h6 class="mt-2 mb-1">Calculate Order</h6>
                                    <small class="text-muted" id="stage2Status">Waiting...</small>
                                    <div id="stage2Details" style="display: none;" class="mt-2">
                                        <span class="badge bg-success" id="productsCount"></span>
                                        <span class="badge bg-info" id="packagesCount"></span>
                                    </div>
                                    <div id="stage2Time" class="text-muted small mt-1" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light" id="stage3Card">
                                <div class="card-body text-center">
                                    <i class="bi bi-send" style="font-size: 2rem;" id="stage3Icon"></i>
                                    <h6 class="mt-2 mb-1">Execute Order</h6>
                                    <small class="text-muted" id="stage3Status">Waiting...</small>
                                    <div id="stage3Time" class="text-muted small mt-1" style="display:none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div id="errorContainer" class="alert alert-danger mt-3" style="display: none;">
                        <h6><i class="bi bi-x-circle"></i> Error</h6>
                        <p class="mb-2" id="errorMessage"></p>
                        <div id="retrySection" style="display: none;">
                            <p class="mb-2">
                                <strong>Retry:</strong> <span id="retryInfo"></span>
                            </p>
                            <button onclick="retryFromCheckpoint()" class="btn btn-warning btn-sm">
                                <i class="bi bi-arrow-repeat"></i> Retry from Checkpoint
                            </button>
                        </div>
                    </div>

                    <!-- Success Display -->
                    <div id="successContainer" class="alert alert-success mt-3" style="display: none;">
                        <h6><i class="bi bi-check-circle"></i> Completed Successfully!</h6>
                        <p class="mb-2" id="successMessage"></p>
                        <a href="#" id="viewLogLink" class="btn btn-sm btn-success">
                            <i class="bi bi-eye"></i> View Detailed Log
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let pollingInterval;
let currentLogId;
let pollCount = 0;
const MAX_POLLS = 900; // 30 minutes at 2 sec intervals (was 10 min - too short!)
let consecutiveErrors = 0;
const MAX_CONSECUTIVE_ERRORS = 5;

document.getElementById('restockForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Hide form, show progress
    document.getElementById('restockForm').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'block';
    
    // Submit form via AJAX to get log ID
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.log_id) {
            currentLogId = data.log_id;
            startProgressPolling(data.log_id);
        } else {
            showError('Failed to start restock process');
        }
    })
    .catch(error => {
        showError('Error starting restock: ' + error);
    });
});

function startProgressPolling(logId) {
    pollCount = 0;
    consecutiveErrors = 0;
    
    console.log(`Starting polling for log ${logId}, max polls: ${MAX_POLLS}`);
    
    // Poll every 2 seconds
    pollingInterval = setInterval(() => {
        pollCount++;
        
        if (pollCount > MAX_POLLS) {
            clearInterval(pollingInterval);
            console.error('Max polls reached, checking final status...');
            
            // Do one final check before timing out
            fetch(`/logs/${logId}/progress/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'completed' || data.status === 'failed') {
                        updateProgress(data);
                    } else {
                        showError('Operation timed out. Refreshing to check final status...');
                        setTimeout(() => window.location.reload(), 2000);
                    }
                })
                .catch(() => {
                    showError('Operation timed out. Please refresh the page to check status.');
                });
            return;
        }
        
        // Show progress indicator every 30 seconds
        if (pollCount % 15 === 0) {
            console.log(`Poll ${pollCount}/${MAX_POLLS} - Still checking...`);
        }
        
        fetch(`/logs/${logId}/progress/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                consecutiveErrors = 0; // Reset error counter on success
                updateProgress(data);
            })
            .catch(error => {
                consecutiveErrors++;
                console.error(`Polling error (${consecutiveErrors}/${MAX_CONSECUTIVE_ERRORS}):`, error);
                
                // Only stop after multiple consecutive errors
                if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS) {
                    clearInterval(pollingInterval);
                    showError('Lost connection to server. Refreshing page...');
                    setTimeout(() => window.location.reload(), 2000);
                }
                // Otherwise just log and continue polling
            });
    }, 2000);
}

function updateProgress(data) {
    // Update progress bar
    document.getElementById('progressBar').style.width = data.progress + '%';
    document.getElementById('progressBar').textContent = data.progress + '%';
    document.getElementById('progressPercent').textContent = data.progress + '%';
    document.getElementById('stageLabel').textContent = data.stage_label;
    
    // Update stage details text
    if (data.stage_details) {
        document.getElementById('stageDetailsText').textContent = data.stage_details;
    }
    
    // Update stage cards with animation
    updateStageCard(1, data.current_stage, data.stats_updated_at);
    updateStageCard(2, data.current_stage, data.order_calculated_at, data.products_ordered, data.total_packages);
    updateStageCard(3, data.current_stage, data.order_executed_at);
    
    // Handle completion
    if (data.status === 'completed') {
        clearInterval(pollingInterval);
        showSuccess(data.products_ordered, data.total_packages, currentLogId);
        document.getElementById('progressBar').classList.remove('progress-bar-animated');
        document.getElementById('progressBar').classList.add('bg-success');
    }
    
    // Handle failure
    if (data.status === 'failed') {
        clearInterval(pollingInterval);
        showError(
            data.error_message || 'Restock failed',
            data.can_retry,
            data.retry_count,
            data.max_retries
        );
        document.getElementById('progressBar').classList.remove('progress-bar-animated');
        document.getElementById('progressBar').classList.add('bg-danger');
    }
}

function updateStageCard(stageNum, currentStage, completedAt, productsOrdered, totalPackages) {
    const card = document.getElementById(`stage${stageNum}Card`);
    const icon = document.getElementById(`stage${stageNum}Icon`);
    const status = document.getElementById(`stage${stageNum}Status`);
    const timeDiv = document.getElementById(`stage${stageNum}Time`);
    
    const stages = {
        1: ['updating_stats', 'stats_updated'],
        2: ['calculating_order', 'order_calculated'],
        3: ['executing_order', 'completed']
    };
    
    const isActive = stages[stageNum].includes(currentStage);
    const isCompleted = completedAt !== null;
    
    // Update card styling with smooth transitions
    if (isCompleted) {
        card.classList.remove('bg-light', 'bg-warning');
        card.classList.add('bg-success', 'text-white');
        icon.className = 'bi bi-check-circle-fill text-white';
        icon.style.fontSize = '2rem';
        status.textContent = 'Completed';
        status.classList.remove('text-muted');
        status.classList.add('text-white');
        
        // Show completion time
        if (completedAt) {
            const time = new Date(completedAt).toLocaleTimeString();
            timeDiv.textContent = `at ${time}`;
            timeDiv.style.display = 'block';
        }
    } else if (isActive) {
        card.classList.remove('bg-light');
        card.classList.add('bg-warning');
        icon.classList.add('text-dark');
        
        // Add pulsing animation
        icon.style.animation = 'pulse 1.5s infinite';
        
        status.textContent = 'In Progress...';
        status.classList.remove('text-muted');
        status.classList.add('text-dark');
    }
    
    // Show order details for stage 2
    if (stageNum === 2 && isCompleted && productsOrdered) {
        document.getElementById('stage2Details').style.display = 'block';
        document.getElementById('productsCount').textContent = `${productsOrdered} products`;
        document.getElementById('packagesCount').textContent = `${totalPackages} packages`;
    }
}

function showSuccess(products, packages, logId) {
    const successContainer = document.getElementById('successContainer');
    const successMessage = document.getElementById('successMessage');
    const viewLogLink = document.getElementById('viewLogLink');
    
    successMessage.innerHTML = `
        Successfully ordered ${products} products (${packages} packages total)<br>
        <small class="text-white">Redirecting to detailed log in 3 seconds...</small>
    `;
    viewLogLink.href = `/logs/${logId}/`;
    successContainer.style.display = 'block';
    
    // Auto-redirect after 3 seconds
    setTimeout(() => {
        window.location.href = `/logs/${logId}/`;
    }, 3000);
}

function showError(message, canRetry, retryCount, maxRetries) {
    const errorContainer = document.getElementById('errorContainer');
    const errorMessage = document.getElementById('errorMessage');
    const retrySection = document.getElementById('retrySection');
    const retryInfo = document.getElementById('retryInfo');
    
    errorMessage.textContent = message;
    
    if (canRetry) {
        retryInfo.textContent = `Attempt ${retryCount} of ${maxRetries}`;
        retrySection.style.display = 'block';
    }
    
    errorContainer.style.display = 'block';
}

function retryFromCheckpoint() {
    if (!currentLogId) return;
    
    // Hide error, show progress again
    document.getElementById('errorContainer').style.display = 'none';
    
    // Reset UI
    pollCount = 0;
    
    // Submit retry request
    fetch(`/logs/${currentLogId}/retry/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            startProgressPolling(currentLogId);
        } else {
            showError(data.message || 'Retry failed');
        }
    })
    .catch(error => {
        showError('Error initiating retry: ' + error);
    });
}

// Add CSS for pulse animation
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}