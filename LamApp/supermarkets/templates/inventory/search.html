{% extends 'base.html' %}
{% block title %}Ricerca Inventario{% endblock %}
{% block page_title %}Ricerca Inventario{% endblock %}

{% block extra_css %}
<style>
    .product-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 6px 6px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .product-search-results .dropdown-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }
    .product-search-results .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    .product-search-results .dropdown-item:last-child {
        border-bottom: none;
    }
    .selected-product-display {
        background-color: #e8f4f8;
        border-radius: 6px;
        padding: 10px 15px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <!-- Search Form - Compact -->
        <div class="col-lg-6">
            <div class="stat-card h-100">
                <h5 class="mb-3">
                    <i class="bi bi-search text-primary"></i> Ricerca Inventario
                </h5>

                <form method="post" id="searchForm">
                    {% csrf_token %}

                    <!-- Search Type Selection - Inline -->
                    <div class="mb-3">
                        <div class="d-flex flex-wrap gap-3">
                            {% for radio in form.search_type %}
                            <div class="form-check">
                                {{ radio.tag }}
                                <label class="form-check-label small" for="{{ radio.id_for_label }}">
                                    {{ radio.choice_label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Code + Variant Fields -->
                    <div id="codVarFields" class="search-fields">
                        <!-- Hidden fields for form submission -->
                        <input type="hidden" name="product_code" id="id_product_code">
                        <input type="hidden" name="product_var" id="id_product_var">

                        <!-- Toggle between ILIKE and manual cod.var -->
                        <div class="mb-2">
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <input type="radio" class="btn-check" name="codvar_mode" id="modeIlike" value="ilike" checked>
                                <label class="btn btn-outline-primary" for="modeIlike">
                                    <i class="bi bi-search"></i> Cerca per descrizione
                                </label>
                                <input type="radio" class="btn-check" name="codvar_mode" id="modeCodVar" value="codvar">
                                <label class="btn btn-outline-primary" for="modeCodVar">
                                    <i class="bi bi-123"></i> Codice + Variante
                                </label>
                            </div>
                        </div>

                        <!-- ILIKE search panel -->
                        <div id="ilikePanel">
                            <!-- Supermarket selection for ILIKE search -->
                            <div class="row mb-2">
                                <div class="col-12">
                                    <label class="form-label small mb-1">Punto Vendita</label>
                                    <select id="searchSupermarket" class="form-select form-select-sm">
                                        {% if user_supermarkets|length == 1 %}
                                        {% for sm in user_supermarkets %}
                                        <option value="{{ sm.id }}" selected>{{ sm.name }}</option>
                                        {% endfor %}
                                        {% else %}
                                        <option value="">-- Seleziona Punto Vendita --</option>
                                        {% for sm in user_supermarkets %}
                                        <option value="{{ sm.id }}">{{ sm.name }}</option>
                                        {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>

                            <!-- ILIKE Product Search -->
                            <div class="row">
                                <div class="col-12 mb-2">
                                    <label class="form-label small mb-1">Cerca Prodotto (min. 3 caratteri)</label>
                                    <div class="position-relative">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                                            <input type="text" class="form-control" id="productSearchInput"
                                                   placeholder="Cerca per descrizione...">
                                        </div>
                                        <div class="product-search-results" id="productSearchResults"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Selected product display -->
                            <div id="selectedProductDisplay" class="selected-product-display" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong id="selectedProductCode"></strong>
                                        <span class="text-muted ms-2" id="selectedProductDesc"></span>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearSelectedProduct()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Manual cod.var panel -->
                        <div id="codVarPanel" style="display: none;">
                            <div class="row">
                                <div class="col-8 mb-2">
                                    <label class="form-label small mb-1">Codice Prodotto</label>
                                    <input type="number" class="form-control" id="manualCodInput" placeholder="es. 12345">
                                </div>
                                <div class="col-4 mb-2">
                                    <label class="form-label small mb-1">Variante</label>
                                    <input type="number" class="form-control" id="manualVarInput" placeholder="1" value="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settore/Cluster Fields -->
                    <div id="settoreFields" class="search-fields" style="display: none;">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label for="id_supermarket" class="form-label small mb-1">Punto vendita</label>
                                {{ form.supermarket }}
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="settore_display" class="form-label small mb-1">Magazzino</label>
                                <select id="settore_display" class="form-select form-select-sm">
                                    <option value="">-- Seleziona --</option>
                                </select>
                                <input type="hidden" name="settore" id="id_settore">
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="cluster_display" class="form-label small mb-1">Cluster</label>
                                <select id="cluster_display" class="form-select form-select-sm">
                                    <option value="">-- Tutti --</option>
                                </select>
                                <input type="hidden" name="cluster" id="id_cluster">
                            </div>
                        </div>
                    </div>

                    {% if form.errors %}
                    <div class="alert alert-danger py-2 small">{{ form.errors }}</div>
                    {% endif %}

                    <div class="d-flex gap-2 justify-content-end mt-2">
                        <a href="{% url 'dashboard' %}" class="btn btn-sm btn-secondary">
                            <i class="bi bi-x-circle"></i> Annulla
                        </a>
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="bi bi-search"></i> Cerca
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Operations Section - Compact -->
        <div class="col-lg-6">
            <div class="stat-card h-100">
                <!-- Operazioni Inventario -->
                <h6 class="mb-2"><i class="bi bi-tools text-primary"></i> Operazioni Inventario</h6>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <a href="{% url 'verify-stock-unified-enhanced' %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-clipboard-check"></i> Carica inventario
                    </a>
                    <a href="{% url 'assign-clusters' %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-folder"></i> Assegna Clusters
                    </a>
                    <a href="{% url 'record-losses-unified' %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-clipboard-data"></i> Registra Perdite
                    </a>
                    <a href="{% url 'edit-losses' %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-pencil-square"></i> Modifica Perdite
                    </a>
                    <a href="{% url 'promo-products' %}" class="btn btn-sm btn-success">
                        <i class="bi bi-tag"></i> Articoli in promozione
                    </a>
                </div>

                <!-- Monitoraggio -->
                <h6 class="mb-2"><i class="bi bi-bar-chart text-success"></i> Monitoraggio</h6>
                <div class="d-flex flex-wrap gap-2">
                    <a href="{% url 'stock-value-unified' %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-cash-stack"></i> Valorizzazione inventario
                    </a>
                    <a href="{% url 'losses-analytics-unified' %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-graph-up"></i> Analisi delle perdite
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchTypeRadios = document.querySelectorAll('input[name="search_type"]');
    const codVarFields = document.getElementById('codVarFields');
    const settoreFields = document.getElementById('settoreFields');
    const supermarketSelect = document.getElementById('id_supermarket');
    const settoreDisplay = document.getElementById('settore_display');
    const settoreHidden = document.getElementById('id_settore');
    const clusterDisplay = document.getElementById('cluster_display');
    const clusterHidden = document.getElementById('id_cluster');

    // ILIKE search elements
    const searchSupermarket = document.getElementById('searchSupermarket');
    const productSearchInput = document.getElementById('productSearchInput');
    const productSearchResults = document.getElementById('productSearchResults');
    const selectedProductDisplay = document.getElementById('selectedProductDisplay');
    const selectedProductCode = document.getElementById('selectedProductCode');
    const selectedProductDesc = document.getElementById('selectedProductDesc');
    const productCodeHidden = document.getElementById('id_product_code');
    const productVarHidden = document.getElementById('id_product_var');

    // cod.var mode toggle elements
    const ilikePanel = document.getElementById('ilikePanel');
    const codVarPanel = document.getElementById('codVarPanel');
    const modeRadios = document.querySelectorAll('input[name="codvar_mode"]');
    const manualCodInput = document.getElementById('manualCodInput');
    const manualVarInput = document.getElementById('manualVarInput');

    // Debounce configuration
    let searchTimeout = null;
    const DEBOUNCE_MS = 500;
    const MIN_CHARS = 3;

    // Toggle between ILIKE and manual cod.var mode
    modeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'ilike') {
                ilikePanel.style.display = 'block';
                codVarPanel.style.display = 'none';
                manualCodInput.value = '';
                manualVarInput.value = '1';
                productCodeHidden.value = '';
                productVarHidden.value = '';
            } else {
                ilikePanel.style.display = 'none';
                codVarPanel.style.display = 'block';
                productSearchInput.value = '';
                productSearchResults.style.display = 'none';
                selectedProductDisplay.style.display = 'none';
                productCodeHidden.value = '';
                productVarHidden.value = manualVarInput.value;
            }
        });
    });

    // Sync manual cod.var inputs to hidden fields
    manualCodInput.addEventListener('input', function() {
        productCodeHidden.value = this.value;
    });
    manualVarInput.addEventListener('input', function() {
        productVarHidden.value = this.value;
    });

    function updateFieldsVisibility() {
        const selectedType = document.querySelector('input[name="search_type"]:checked').value;

        if (selectedType === 'cod_var') {
            codVarFields.style.display = 'block';
            settoreFields.style.display = 'none';
        } else if (selectedType === 'settore_cluster') {
            codVarFields.style.display = 'none';
            settoreFields.style.display = 'block';

            // If supermarket already has a value (e.g. single supermarket auto-selected), load settores
            if (supermarketSelect.value) {
                loadSettores(supermarketSelect.value);
            }
        }
    }

    searchTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateFieldsVisibility);
    });

    // ILIKE Product Search
    productSearchInput.addEventListener('input', function() {
        const query = this.value.trim();

        if (searchTimeout) clearTimeout(searchTimeout);

        if (query.length < MIN_CHARS) {
            productSearchResults.style.display = 'none';
            return;
        }

        const supermarketId = searchSupermarket.value;
        if (!supermarketId) {
            alert('Seleziona prima un Punto Vendita');
            return;
        }

        // Show loading
        productSearchResults.innerHTML = '<div class="dropdown-item text-muted"><i class="bi bi-hourglass-split"></i> Ricerca...</div>';
        productSearchResults.style.display = 'block';

        searchTimeout = setTimeout(() => {
            fetch(`/inventory/api/search-products/?q=${encodeURIComponent(query)}&supermarket_id=${supermarketId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        productSearchResults.innerHTML = `<div class="dropdown-item text-danger">${data.error}</div>`;
                    } else if (data.products.length === 0) {
                        productSearchResults.innerHTML = '<div class="dropdown-item text-muted">Nessun risultato</div>';
                    } else {
                        productSearchResults.innerHTML = data.products.map(p => `
                            <div class="dropdown-item" data-cod="${p.cod}" data-var="${p.var}" data-desc="${p.description}">
                                <strong>${p.cod}.${p.var}</strong> - ${p.description}
                            </div>
                        `).join('');

                        // Add click handlers
                        productSearchResults.querySelectorAll('.dropdown-item').forEach(item => {
                            item.addEventListener('click', function() {
                                selectProduct(this.dataset.cod, this.dataset.var, this.dataset.desc);
                            });
                        });
                    }
                    productSearchResults.style.display = 'block';
                })
                .catch(err => {
                    console.error('Search error:', err);
                    productSearchResults.innerHTML = '<div class="dropdown-item text-danger">Errore di ricerca</div>';
                    productSearchResults.style.display = 'block';
                });
        }, DEBOUNCE_MS);
    });

    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!productSearchInput.contains(e.target) && !productSearchResults.contains(e.target)) {
            productSearchResults.style.display = 'none';
        }
    });

    function selectProduct(cod, varVal, description) {
        productCodeHidden.value = cod;
        productVarHidden.value = varVal;
        selectedProductCode.textContent = `${cod}.${varVal}`;
        selectedProductDesc.textContent = description;
        selectedProductDisplay.style.display = 'block';
        productSearchInput.value = '';
        productSearchResults.style.display = 'none';
    }

    window.clearSelectedProduct = function() {
        productCodeHidden.value = '';
        productVarHidden.value = '';
        selectedProductDisplay.style.display = 'none';
    };

    // Settore/Cluster logic - extracted to reusable function
    function loadSettores(supermarketId) {
        fetch(`/inventory/api/settores/${supermarketId}/`)
            .then(response => response.json())
            .then(data => {
                settoreDisplay.innerHTML = '<option value="">-- Seleziona Magazzino --</option>';

                data.settores.forEach(settore => {
                    const option = document.createElement('option');
                    option.value = settore;
                    option.textContent = settore;
                    settoreDisplay.appendChild(option);
                });

                clusterDisplay.innerHTML = '<option value="">-- All Clusters --</option>';
                clusterHidden.value = '';
            })
            .catch(error => {
                console.error('Error loading settores:', error);
            });
    }

    supermarketSelect.addEventListener('change', function() {
        const supermarketId = this.value;

        if (!supermarketId) {
            settoreDisplay.innerHTML = '<option value="">-- Seleziona Magazzino --</option>';
            settoreHidden.value = '';
            clusterDisplay.innerHTML = '<option value="">-- All Clusters --</option>';
            clusterHidden.value = '';
            return;
        }

        loadSettores(supermarketId);
    });

    settoreDisplay.addEventListener('change', function() {
        const supermarketId = supermarketSelect.value;
        const settore = this.value;

        settoreHidden.value = settore;

        if (!supermarketId || !settore) {
            clusterDisplay.innerHTML = '<option value="">-- All Clusters --</option>';
            clusterHidden.value = '';
            return;
        }

        fetch(`/inventory/api/clusters/${supermarketId}/${encodeURIComponent(settore)}/`)
            .then(response => response.json())
            .then(data => {
                clusterDisplay.innerHTML = '<option value="">-- All Clusters --</option>';

                data.clusters.forEach(cluster => {
                    const option = document.createElement('option');
                    option.value = cluster;
                    option.textContent = cluster;
                    clusterDisplay.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading clusters:', error);
            });
    });

    clusterDisplay.addEventListener('change', function() {
        clusterHidden.value = this.value;
    });

    updateFieldsVisibility();
});
</script>
{% endblock %}