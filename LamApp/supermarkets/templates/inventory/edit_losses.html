<!-- LamApp/supermarkets/templates/inventory/edit_losses.html -->
{% extends 'base.html' %}
{% block title %}Modifica registro Perdite{% endblock %}
{% block page_title %}Modifica registro Perdite{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'inventory-search' %}">Inventario</a></li>
                    <li class="breadcrumb-item active">Modifica Perdite</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Filtri -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stat-card">
                <h5 class="mb-3"><i class="bi bi-funnel"></i> Filtri</h5>
                <form method="get" class="row g-3">
                    <div class="col-md-6">
                        <label for="supermarket_id" class="form-label">Supermercato</label>
                        <select name="supermarket_id" id="supermarket_id" class="form-select" onchange="this.form.submit()">
                            <option value="">Tutti i Supermercati</option>
                            {% for sm in supermarkets %}
                            <option value="{{ sm.id }}" {% if sm.id|stringformat:"s" == selected_supermarket %}selected{% endif %}>
                                {{ sm.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="storage_id" class="form-label">Magazzino</label>
                        <select name="storage_id" id="storage_id" class="form-select" onchange="this.form.submit()">
                            <option value="">Tutti i Supermercati</option>
                            {% for storage in storages %}
                            <option value="{{ storage.id }}" 
                                    {% if storage.id|stringformat:"s" == selected_storage %}selected{% endif %}>
                                {{ storage.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <a href="{% url 'edit-losses' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Togli Filtri
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <h6><i class="bi bi-exclamation-triangle"></i> IMPORTANTE</h6>
                <p class="mb-0">
                    <strong>La modifica delle perdite qui NON influisce sui livelli delle giacenze.</strong> 
                    Utilizzare questo per correggere errori di registrazione. 
                    <a href="{% url 'inventory-search' %}" class="alert-link">Ricerca Inventario</a>.
                </p>
            </div>
        </div>
    </div>

    <!-- Products with Perdite -->
    <div class="row">
        <div class="col-12">
            <div class="stat-card">
                <h5 class="mb-4">
                    <i class="bi bi-pencil-square"></i> Articoli con Perdite reggistrate
                    <span class="badge bg-secondary">{{ products|length }} articoli</span>
                </h5>

                {% if products %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Descrizione</th>
                                <th>Supermercato</th>
                                <th class="text-center">Rotture</th>
                                <th class="text-center">Scaduto</th>
                                <th class="text-center">Uso interno</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in products %}
                            <tr>
                                <td><code>{{ product.cod }}.{{ product.var }}</code></td>
                                <td>{{ product.description|truncatewords:6 }}</td>
                                <td><small class="text-muted">{{ product.supermarket_name }}</small></td>
                                <td class="text-center">
                                    {% if product.broken %}
                                        <span class="badge bg-danger">{{ product.broken|length }} mesi</span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if product.expired %}
                                        <span class="badge bg-warning">{{ product.expired|length }} mesi</span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if product.internal %}
                                        <span class="badge bg-info">{{ product.internal|length }} mesi</span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="editProduct({{ product.cod }}, {{ product.var }}, '{{ product.description|escapejs }}', {{ product.supermarket_id }}, {{ product.broken|safe }}, {{ product.expired|safe }}, {{ product.internal|safe }})">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Nessun articolo con perdite registrate trovato per i filtri selezionati.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Loss Modal -->
<div class="modal fade" id="editLossModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifica reggistro Perdite</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Nota bene:</strong> Le modifiche apportate NON incideranno sui livelli delle giacenze.
                    Serve solo a correggere gli errori di registrazione.
                </div>

                <h6 id="productTitle" class="mb-3"></h6>
                
                <input type="hidden" id="edit_supermarket_id">
                <input type="hidden" id="edit_cod">
                <input type="hidden" id="edit_var">

                <!-- Broken Perdite -->
                <div class="mb-4">
                    <h6 class="text-danger">
                        <i class="bi bi-x-octagon"></i> Rotture
                    </h6>
                    <div id="brokenArrayContainer" class="row g-2"></div>
                </div>

                <!-- Expired Perdite -->
                <div class="mb-4">
                    <h6 class="text-warning">
                        <i class="bi bi-calendar-x"></i> Scaduto
                    </h6>
                    <div id="expiredArrayContainer" class="row g-2"></div>
                </div>

                <!-- Internal Perdite -->
                <div class="mb-4">
                    <h6 class="text-info">
                        <i class="bi bi-people"></i> Utilizzo interno
                    </h6>
                    <div id="internalArrayContainer" class="row g-2"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const editModal = new bootstrap.Modal(document.getElementById('editLossModal'));

function editProduct(cod, var_, description, supermarketId, brokenArray, expiredArray, internalArray) {
    // Store IDs
    document.getElementById('edit_supermarket_id').value = supermarketId;
    document.getElementById('edit_cod').value = cod;
    document.getElementById('edit_var').value = var_;
    
    // Set title
    document.getElementById('productTitle').textContent = `${cod}.${var_} - ${description}`;
    
    // Render arrays with cost information
    renderLossArray('broken', brokenArray);
    renderLossArray('expired', expiredArray);
    renderLossArray('internal', internalArray);
    
    editModal.show();
}

function renderLossArray(lossType, array) {
    const container = document.getElementById(`${lossType}ArrayContainer`);
    container.innerHTML = '';
    
    if (!array || array.length === 0) {
        container.innerHTML = '<p class="text-muted">No losses recorded</p>';
        return;
    }
    
    const monthsToShow = Math.min(12, array.length);
    
    for (let i = 0; i < monthsToShow; i++) {
        const item = array[i];
        
        // Handle the data format from Python: {qty, cost, value}
        const qty = item.qty || item;
        const cost = item.cost || 0;
        const value = item.value || (qty * cost);
        
        const monthLabel = i === 0 ? 'Current' : `${i} mo ago`;
        
        const col = document.createElement('div');
        col.className = 'col-md-4';
        col.innerHTML = `
            <div class="card border-0 bg-light mb-2">
                <div class="card-body p-2">
                    <small class="text-muted d-block mb-1">${monthLabel}</small>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">Qty</span>
                        <input type="number" 
                               class="form-control" 
                               value="${qty}" 
                               min="0"
                               onchange="updateLossValue(event, '${lossType}', ${i}, this.value)">
                    </div>
                    <small class="text-muted d-block mt-1">
                        <i class="bi bi-currency-euro"></i> ${cost.toFixed(2)} × ${qty} = 
                        <strong>€${value.toFixed(2)}</strong>
                    </small>
                </div>
            </div>
        `;
        container.appendChild(col);
    }
    
    // Add info alert about cost snapshots
    const infoDiv = document.createElement('div');
    infoDiv.className = 'col-12 mt-2';
    infoDiv.innerHTML = `
        <div class="alert alert-info alert-sm mb-0">
            <i class="bi bi-info-circle"></i>
            <small>Cost values are historical snapshots from when losses were recorded. 
            Editing quantity preserves the original cost.</small>
        </div>
    `;
    container.appendChild(infoDiv);
}

function updateLossValue(event, lossType, monthIndex, newValue) {
    const supermarketId = document.getElementById('edit_supermarket_id').value;
    const cod = document.getElementById('edit_cod').value;
    const var_ = document.getElementById('edit_var').value;
    
    const csrfToken = '{{ csrf_token }}';
    
    fetch('/inventory/edit-loss/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            supermarket_id: parseInt(supermarketId),
            cod: parseInt(cod),
            var: parseInt(var_),
            loss_type: lossType,
            month_index: monthIndex,
            new_value: parseInt(newValue)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success feedback
            const input = event.target;
            const originalBorder = input.style.border;
            const originalBackground = input.style.background;
            
            input.style.border = '2px solid #28a745';
            input.style.background = '#d4edda';
            
            setTimeout(() => {
                input.style.border = originalBorder;
                input.style.background = originalBackground;
            }, 1500);
            
            console.log(data.message);
            
            // Show toast notification
            const toastHtml = `
                <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11000">
                    <div class="toast show" role="alert">
                        <div class="toast-header bg-success text-white">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong class="me-auto">Updated</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${data.message}
                        </div>
                    </div>
                </div>
            `;
            
            const toastContainer = document.createElement('div');
            toastContainer.innerHTML = toastHtml;
            document.body.appendChild(toastContainer);
            
            setTimeout(() => toastContainer.remove(), 3000);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating loss value: ' + error);
    });
}
</script>
{% endblock %}